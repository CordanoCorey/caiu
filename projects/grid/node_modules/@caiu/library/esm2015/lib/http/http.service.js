/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes} checked by tsc
 */
import { Injectable } from '@angular/core';
import { HttpClient, HttpHeaders } from '@angular/common/http';
import { Observable, of, throwError } from 'rxjs';
import { catchError, debounceTime, distinctUntilChanged, finalize, map } from 'rxjs/operators';
import { HttpActions } from './http.actions';
import { HttpOptions } from './http.models';
import { QueryModel } from '../shared/models';
import { serialize } from '../shared/utils';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
import * as i2 from "rxjs/internal/Observable";
export class HttpService {
    /**
     * @param {?} http
     * @param {?} baseUrl$
     * @param {?} authToken$
     */
    constructor(http, baseUrl$, authToken$) {
        this.http = http;
        this.baseUrl$ = baseUrl$;
        this.authToken$ = authToken$;
        this._authToken = '';
        this._baseUrl = '';
        this.headers = {};
        this.logEvents = true;
        this.useDefaultHeaders = true;
        this.authTokenChanges = this.authToken$.subscribe(x => {
            this.authToken = x;
        });
        this.baseUrlChanges = this.baseUrl$.subscribe(x => {
            this.baseUrl = x;
        });
    }
    /**
     * @return {?}
     */
    get authToken() {
        return this._authToken;
    }
    /**
     * @param {?} value
     * @return {?}
     */
    set authToken(value) {
        this._authToken = value;
    }
    /**
     * @return {?}
     */
    get baseUrl() {
        return this._baseUrl;
    }
    /**
     * @param {?} value
     * @return {?}
     */
    set baseUrl(value) {
        this._baseUrl = value;
    }
    /**
     * @return {?}
     */
    get defaultHeaders() {
        let /** @type {?} */ headers = new HttpHeaders();
        headers = headers.append('Content-type', 'application/json');
        if (this.authToken) {
            headers = headers.append('Authorization', 'Bearer ' + this.authToken);
        }
        return headers;
    }
    /**
     * @return {?}
     */
    get requestHeaders() {
        let /** @type {?} */ headers = this.useDefaultHeaders ? this.defaultHeaders : new HttpHeaders();
        Object.keys(this.headers).forEach(key => {
            headers = headers.append(key, this.headers[key]);
        });
        return headers;
    }
    /**
     * @param {?=} headers
     * @return {?}
     */
    appendHeaders(headers = {}) {
        let /** @type {?} */ requestHeaders = this.requestHeaders;
        Object.keys(headers).forEach(key => {
            requestHeaders = requestHeaders.append(key, this.headers[key]);
        });
        return requestHeaders;
    }
    /**
     * Make a DELETE request.
     * @param {?} relativePath
     * @param {?=} headers
     * @param {?=} options
     * @return {?}
     */
    delete(relativePath, headers = {}, options = new HttpOptions()) {
        const /** @type {?} */ url = options.prependBaseUrl ? this.formatUrl(relativePath) : relativePath;
        const /** @type {?} */ httpHeaders = this.appendHeaders(headers);
        const /** @type {?} */ obs = this.http.delete(url, {
            headers: httpHeaders
        });
        return obs.pipe(map(res => res && res['json'] && typeof res['json'] === 'function' ? res['json']() : res), catchError(err => this.onError(err)), finalize(() => {
            this.onComplete('DELETE', url);
        }));
    }
    /**
     * Make a GET request.
     * @param {?} relativePath
     * @param {?=} headers
     * @param {?=} options
     * @return {?}
     */
    get(relativePath, headers = {}, options = new HttpOptions()) {
        const /** @type {?} */ url = options.prependBaseUrl ? this.formatUrl(relativePath) : relativePath;
        const /** @type {?} */ httpHeaders = this.appendHeaders(headers);
        const /** @type {?} */ obs = this.http.get(url, {
            headers: httpHeaders
        });
        return obs.pipe(map(res => res && res['json'] && typeof res['json'] === 'function' ? res['json']() : res), catchError(err => this.onError(err)), finalize(() => {
            this.onComplete('GET', url);
        }));
    }
    ;
    /**
     * Make an autocomplete GET request.
     * @param {?} relativePath
     * @param {?} query
     * @param {?=} headers
     * @param {?=} options
     * @return {?}
     */
    autocomplete(relativePath, query, headers = {}, options = new HttpOptions()) {
        if (!query.term || query.term.length < 1) {
            return of([]);
        }
        const /** @type {?} */ path = `${relativePath}/${QueryModel.BuildQueryString(query)}`;
        const /** @type {?} */ url = options.prependBaseUrl ? this.formatUrl(relativePath) : relativePath;
        const /** @type {?} */ httpHeaders = this.appendHeaders(headers);
        const /** @type {?} */ obs = this.http.get(url, {
            headers: httpHeaders
        });
        return obs.pipe(map(res => res && res['json'] && typeof res['json'] === 'function' ? res['json']() : res), debounceTime(500), distinctUntilChanged(), map(json => HttpActions.matchPath(path, json)), catchError(err => this.onError(err)), finalize(() => {
            this.onComplete('GET', url);
        }));
    }
    ;
    /**
     * Make a POST request.
     * @param {?} relativePath
     * @param {?} body
     * @param {?=} headers
     * @param {?=} options
     * @return {?}
     */
    post(relativePath, body, headers = {}, options = new HttpOptions()) {
        const /** @type {?} */ url = options.prependBaseUrl ? this.formatUrl(relativePath) : relativePath;
        const /** @type {?} */ httpHeaders = this.appendHeaders(headers);
        const /** @type {?} */ obs = this.http.post(url, serialize(body), {
            headers: httpHeaders
        });
        return obs.pipe(map(res => res && res['json'] && typeof res['json'] === 'function' ? res['json']() : res), catchError(err => this.onError(err)), finalize(() => {
            this.onComplete('POST', url);
        }));
    }
    /**
     * Make a POST request with form url-encoded content type.
     * @param {?} relativePath
     * @param {?} body
     * @param {?=} headers
     * @param {?=} options
     * @return {?}
     */
    postFormUrlEncoded(relativePath, body, headers = {}, options = new HttpOptions()) {
        const /** @type {?} */ url = options.prependBaseUrl ? this.formatUrl(relativePath) : relativePath;
        const /** @type {?} */ httpHeaders = new HttpHeaders({ 'content-type': 'application/x-www-form-urlencoded' });
        const /** @type {?} */ obs = this.http.post(url, body, {
            headers: httpHeaders
        });
        return obs.pipe(map(res => res && res['json'] && typeof res['json'] === 'function' ? res['json']() : res), catchError(err => this.onError(err)), finalize(() => {
            this.onComplete('POST FORM URL-ENCODED', url);
        }));
    }
    /**
     * Make a PUT request.
     * @param {?} relativePath
     * @param {?} body
     * @param {?=} headers
     * @param {?=} options
     * @return {?}
     */
    put(relativePath, body, headers = {}, options = new HttpOptions()) {
        const /** @type {?} */ url = options.prependBaseUrl ? this.formatUrl(relativePath) : relativePath;
        const /** @type {?} */ httpHeaders = this.appendHeaders(headers);
        const /** @type {?} */ obs = this.http.put(url, serialize(body), {
            headers: httpHeaders
        });
        return obs.pipe(map(res => res && res['json'] && typeof res['json'] === 'function' ? res['json']() : res), catchError(err => this.onError(err)), finalize(() => {
            this.onComplete('PUT', url);
        }));
    }
    /**
     * This method will be used to format URLs for all cross-origin requests.
     * @param {?} path
     * @return {?}
     */
    formatUrl(path) {
        return `${this.baseUrl}/${path}`;
    }
    /**
     * Use this method when a promise is preferred over an observable.
     * @param {?} url
     * @return {?}
     */
    getPromise(url) {
        return this.get(url)
            .toPromise()
            .then(res => res.json());
    }
    /**
     * @param {?} error
     * @return {?}
     */
    onError(error) {
        let /** @type {?} */ errorBody;
        try {
            errorBody = (error._body) ? JSON.parse(error._body) : { message: 'Internal server error', statusCode: error.status };
        }
        catch (/** @type {?} */ e) {
            if (error.status <= 0) {
                errorBody = { message: 'Internal server error.', statusCode: 500 };
            }
        }
        if (errorBody.message) {
            errorBody.message = errorBody.message.replace('An error has occured in the api.System.Exception: ', '');
            errorBody.message = errorBody.message.substring(0, errorBody.message.indexOf(' at'));
        }
        return throwError(errorBody);
    }
    /**
     * @param {?} method
     * @param {?} url
     * @return {?}
     */
    onComplete(method, url) {
        if (this.logEvents) {
            console.log(`Completed ${method} request to ${url}`);
        }
    }
}
HttpService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] },
];
/** @nocollapse */
HttpService.ctorParameters = () => [
    { type: HttpClient },
    { type: Observable },
    { type: Observable }
];
/** @nocollapse */ HttpService.ngInjectableDef = i0.defineInjectable({ factory: function HttpService_Factory() { return new HttpService(i0.inject(i1.HttpClient), i0.inject(i2.Observable), i0.inject(i2.Observable)); }, token: HttpService, providedIn: "root" });
function HttpService_tsickle_Closure_declarations() {
    /** @type {?} */
    HttpService.prototype._authToken;
    /** @type {?} */
    HttpService.prototype._baseUrl;
    /** @type {?} */
    HttpService.prototype.authTokenChanges;
    /** @type {?} */
    HttpService.prototype.baseUrlChanges;
    /** @type {?} */
    HttpService.prototype.headers;
    /** @type {?} */
    HttpService.prototype.logEvents;
    /** @type {?} */
    HttpService.prototype.useDefaultHeaders;
    /** @type {?} */
    HttpService.prototype.http;
    /** @type {?} */
    HttpService.prototype.baseUrl$;
    /** @type {?} */
    HttpService.prototype.authToken$;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaHR0cC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGNhaXUvbGlicmFyeS8iLCJzb3VyY2VzIjpbImxpYi9odHRwL2h0dHAuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsVUFBVSxFQUFFLFdBQVcsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQy9ELE9BQU8sRUFBRSxVQUFVLEVBQWdCLEVBQUUsRUFBRSxVQUFVLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDaEUsT0FBTyxFQUNILFVBQVUsRUFDVixZQUFZLEVBQ1osb0JBQW9CLEVBQ3BCLFFBQVEsRUFDUixHQUFHLEVBQ04sTUFBTSxnQkFBZ0IsQ0FBQztBQUV4QixPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDN0MsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUM1QyxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDOUMsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGlCQUFpQixDQUFDOzs7O0FBSzVDLE1BQU07Ozs7OztJQVVGLFlBQ1csTUFDQyxVQUNBO1FBRkQsU0FBSSxHQUFKLElBQUk7UUFDSCxhQUFRLEdBQVIsUUFBUTtRQUNSLGVBQVUsR0FBVixVQUFVOzBCQVhELEVBQUU7d0JBQ0osRUFBRTt1QkFHWCxFQUFFO3lCQUNBLElBQUk7aUNBQ0ksSUFBSTtRQU9wQixJQUFJLENBQUMsZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLEVBQUU7WUFDbEQsSUFBSSxDQUFDLFNBQVMsR0FBRyxDQUFDLENBQUM7U0FDdEIsQ0FBQyxDQUFDO1FBQ0gsSUFBSSxDQUFDLGNBQWMsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsRUFBRTtZ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IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBIdHRwQ2xpZW50LCBIdHRwSGVhZGVycyB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcbmltcG9ydCB7IE9ic2VydmFibGUsIFN1YnNjcmlwdGlvbiwgb2YsIHRocm93RXJyb3IgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7XG4gICAgY2F0Y2hFcnJvcixcbiAgICBkZWJvdW5jZVRpbWUsXG4gICAgZGlzdGluY3RVbnRpbENoYW5nZWQsXG4gICAgZmluYWxpemUsXG4gICAgbWFwXG59IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuaW1wb3J0IHsgSHR0cEFjdGlvbnMgfSBmcm9tICcuL2h0dHAuYWN0aW9ucyc7XG5pbXBvcnQgeyBIdHRwT3B0aW9ucyB9IGZyb20gJy4vaHR0cC5tb2RlbHMnO1xuaW1wb3J0IHsgUXVlcnlNb2RlbCB9IGZyb20gJy4uL3NoYXJlZC9tb2RlbHMnO1xuaW1wb3J0IHsgc2VyaWFsaXplIH0gZnJvbSAnLi4vc2hhcmVkL3V0aWxzJztcblxuQEluamVjdGFibGUoe1xuICAgIHByb3ZpZGVkSW46ICdyb290J1xufSlcbmV4cG9ydCBjbGFzcyBIdHRwU2VydmljZSB7XG5cbiAgICBwcml2YXRlIF9hdXRoVG9rZW4gPSAnJztcbiAgICBwcml2YXRlIF9iYXNlVXJsID0gJyc7XG4gICAgcHJpdmF0ZSBhdXRoVG9rZW5DaGFuZ2VzOiBTdWJzY3JpcHRpb247XG4gICAgcHJpdmF0ZSBiYXNlVXJsQ2hhbmdlczogU3Vic2NyaXB0aW9uO1xuICAgIGhlYWRlcnMgPSB7fTtcbiAgICBsb2dFdmVudHMgPSB0cnVlO1xuICAgIHVzZURlZmF1bHRIZWFkZXJzID0gdHJ1ZTtcblxuICAgIGNvbnN0cnVjdG9yKFxuICAgICAgICBwdWJsaWMgaHR0cDogSHR0cENsaWVudCxcbiAgICAgICAgcHJpdmF0ZSBiYXNlVXJsJDogT2JzZXJ2YWJsZTxzdHJpbmc+LFxuICAgICAgICBwcml2YXRlIGF1dGhUb2tlbiQ6IE9ic2VydmFibGU8c3RyaW5nPlxuICAgICkge1xuICAgICAgICB0aGlzLmF1dGhUb2tlbkNoYW5nZXMgPSB0aGlzLmF1dGhUb2tlbiQuc3Vic2NyaWJlKHggPT4ge1xuICAgICAgICAgICAgdGhpcy5hdXRoVG9rZW4gPSB4O1xuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5iYXNlVXJsQ2hhbmdlcyA9IHRoaXMuYmFzZVVybCQuc3Vic2NyaWJlKHggPT4ge1xuICAgICAgICAgICAgdGhpcy5iYXNlVXJsID0geDtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgZ2V0IGF1dGhUb2tlbigpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gdGhpcy5fYXV0aFRva2VuO1xuICAgIH1cblxuICAgIHNldCBhdXRoVG9rZW4odmFsdWU6IHN0cmluZykge1xuICAgICAgICB0aGlzLl9hdXRoVG9rZW4gPSB2YWx1ZTtcbiAgICB9XG5cbiAgICBnZXQgYmFzZVVybCgpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gdGhpcy5fYmFzZVVybDtcbiAgICB9XG5cbiAgICBzZXQgYmFzZVVybCh2YWx1ZTogc3RyaW5nKSB7XG4gICAgICAgIHRoaXMuX2Jhc2VVcmwgPSB2YWx1ZTtcbiAgICB9XG5cbiAgICBnZXQgZGVmYXVsdEhlYWRlcnMoKTogSHR0cEhlYWRlcnMge1xuICAgICAgICBsZXQgaGVhZGVyczogSHR0cEhlYWRlcnMgPSBuZXcgSHR0cEhlYWRlcnMoKTtcbiAgICAgICAgaGVhZGVycyA9IGhlYWRlcnMuYXBwZW5kKCdDb250ZW50LXR5cGUnLCAnYXBwbGljYXRpb24vanNvbicpO1xuICAgICAgICBpZiAodGhpcy5hdXRoVG9rZW4pIHtcbiAgICAgICAgICAgIGhlYWRlcnMgPSBoZWFkZXJzLmFwcGVuZCgnQXV0aG9yaXphdGlvbicsICdCZWFyZXIgJyArIHRoaXMuYXV0aFRva2VuKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gaGVhZGVycztcbiAgICB9XG5cbiAgICBnZXQgcmVxdWVzdEhlYWRlcnMoKTogSHR0cEhlYWRlcnMge1xuICAgICAgICBsZXQgaGVhZGVyczogSHR0cEhlYWRlcnMgPSB0aGlzLnVzZURlZmF1bHRIZWFkZXJzID8gdGhpcy5kZWZhdWx0SGVhZGVycyA6IG5ldyBIdHRwSGVhZGVycygpO1xuICAgICAgICBPYmplY3Qua2V5cyh0aGlzLmhlYWRlcnMpLmZvckVhY2goa2V5ID0+IHtcbiAgICAgICAgICAgIGhlYWRlcnMgPSBoZWFkZXJzLmFwcGVuZChrZXksIHRoaXMuaGVhZGVyc1trZXldKTtcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBoZWFkZXJzO1xuICAgIH1cblxuICAgIGFwcGVuZEhlYWRlcnMoaGVhZGVycyA9IHt9KTogSHR0cEhlYWRlcnMge1xuICAgICAgICBsZXQgcmVxdWVzdEhlYWRlcnMgPSB0aGlzLnJlcXVlc3RIZWFkZXJzO1xuICAgICAgICBPYmplY3Qua2V5cyhoZWFkZXJzKS5mb3JFYWNoKGtleSA9PiB7XG4gICAgICAgICAgICByZXF1ZXN0SGVhZGVycyA9IHJlcXVlc3RIZWFkZXJzLmFwcGVuZChrZXksIHRoaXMuaGVhZGVyc1trZXldKTtcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiByZXF1ZXN0SGVhZGVycztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBNYWtlIGEgREVMRVRFIHJlcXVlc3QuXG4gICAgICogQHBhcmFtIHJlbGF0aXZlUGF0aCBcbiAgICAgKiBAcGFyYW0gaGVhZGVycyBcbiAgICAgKiBAcGFyYW0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBkZWxldGUocmVsYXRpdmVQYXRoOiBzdHJpbmcsIGhlYWRlcnMgPSB7fSwgb3B0aW9uczogSHR0cE9wdGlvbnMgPSBuZXcgSHR0cE9wdGlvbnMoKSk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgICAgIGNvbnN0IHVybCA9IG9wdGlvbnMucHJlcGVuZEJhc2VVcmwgPyB0aGlzLmZvcm1hdFVybChyZWxhdGl2ZVBhdGgpIDogcmVsYXRpdmVQYXRoO1xuICAgICAgICBjb25zdCBodHRwSGVhZGVycyA9IHRoaXMuYXBwZW5kSGVhZGVycyhoZWFkZXJzKTtcbiAgICAgICAgY29uc3Qgb2JzID0gdGhpcy5odHRwLmRlbGV0ZSh1cmwsIHtcbiAgICAgICAgICAgIGhlYWRlcnM6IGh0dHBIZWFkZXJzXG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gb2JzLnBpcGUoXG4gICAgICAgICAgICBtYXAocmVzID0+IHJlcyAmJiByZXNbJ2pzb24nXSAmJiB0eXBlb2YgcmVzWydqc29uJ10gPT09ICdmdW5jdGlvbicgPyByZXNbJ2pzb24nXSgpIDogcmVzKSxcbiAgICAgICAgICAgIGNhdGNoRXJyb3IoZXJyID0+IHRoaXMub25FcnJvcihlcnIpKSxcbiAgICAgICAgICAgIGZpbmFsaXplKCgpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLm9uQ29tcGxldGUoJ0RFTEVURScsIHVybCk7XG4gICAgICAgICAgICB9KVxuICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIE1ha2UgYSBHRVQgcmVxdWVzdC5cbiAgICAgKiBAcGFyYW0gcmVsYXRpdmVQYXRoIFxuICAgICAqIEBwYXJhbSBoZWFkZXJzIFxuICAgICAqIEBwYXJhbSBvcHRpb25zIFxuICAgICAqL1xuICAgIGdldChyZWxhdGl2ZVBhdGg6IHN0cmluZywgaGVhZGVycyA9IHt9LCBvcHRpb25zOiBIdHRwT3B0aW9ucyA9IG5ldyBIdHRwT3B0aW9ucygpKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICAgICAgY29uc3QgdXJsID0gb3B0aW9ucy5wcmVwZW5kQmFzZVVybCA/IHRoaXMuZm9ybWF0VXJsKHJlbGF0aXZlUGF0aCkgOiByZWxhdGl2ZVBhdGg7XG4gICAgICAgIGNvbnN0IGh0dHBIZWFkZXJzID0gdGhpcy5hcHBlbmRIZWFkZXJzKGhlYWRlcnMpO1xuICAgICAgICBjb25zdCBvYnMgPSB0aGlzLmh0dHAuZ2V0KHVybCwge1xuICAgICAgICAgICAgaGVhZGVyczogaHR0cEhlYWRlcnNcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBvYnMucGlwZShcbiAgICAgICAgICAgIG1hcChyZXMgPT4gcmVzICYmIHJlc1snanNvbiddICYmIHR5cGVvZiByZXNbJ2pzb24nXSA9PT0gJ2Z1bmN0aW9uJyA/IHJlc1snanNvbiddKCkgOiByZXMpLFxuICAgICAgICAgICAgY2F0Y2hFcnJvcihlcnIgPT4gdGhpcy5vbkVycm9yKGVycikpLFxuICAgICAgICAgICAgZmluYWxpemUoKCkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMub25Db21wbGV0ZSgnR0VUJywgdXJsKTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICk7XG4gICAgfTtcblxuICAgIC8qKlxuICAgICAqIE1ha2UgYW4gYXV0b2NvbXBsZXRlIEdFVCByZXF1ZXN0LlxuICAgICAqIEBwYXJhbSByZWxhdGl2ZVBhdGggXG4gICAgICogQHBhcmFtIGhlYWRlcnMgXG4gICAgICogQHBhcmFtIG9wdGlvbnMgXG4gICAgICovXG4gICAgYXV0b2NvbXBsZXRlKHJlbGF0aXZlUGF0aDogc3RyaW5nLCBxdWVyeTogUXVlcnlNb2RlbDxhbnk+LCBoZWFkZXJzID0ge30sIG9wdGlvbnM6IEh0dHBPcHRpb25zID0gbmV3IEh0dHBPcHRpb25zKCkpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgICAgICBpZiAoIXF1ZXJ5LnRlcm0gfHwgcXVlcnkudGVybS5sZW5ndGggPCAxKSB7XG4gICAgICAgICAgICByZXR1cm4gb2YoW10pO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHBhdGggPSBgJHtyZWxhdGl2ZVBhdGh9LyR7UXVlcnlNb2RlbC5CdWlsZFF1ZXJ5U3RyaW5nKHF1ZXJ5KX1gO1xuICAgICAgICBjb25zdCB1cmwgPSBvcHRpb25zLnByZXBlbmRCYXNlVXJsID8gdGhpcy5mb3JtYXRVcmwocmVsYXRpdmVQYXRoKSA6IHJlbGF0aXZlUGF0aDtcbiAgICAgICAgY29uc3QgaHR0cEhlYWRlcnMgPSB0aGlzLmFwcGVuZEhlYWRlcnMoaGVhZGVycyk7XG4gICAgICAgIGNvbnN0IG9icyA9IHRoaXMuaHR0cC5nZXQodXJsLCB7XG4gICAgICAgICAgICBoZWFkZXJzOiBodHRwSGVhZGVyc1xuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIG9icy5waXBlKFxuICAgICAgICAgICAgbWFwKHJlcyA9PiByZXMgJiYgcmVzWydqc29uJ10gJiYgdHlwZW9mIHJlc1snanNvbiddID09PSAnZnVuY3Rpb24nID8gcmVzWydqc29uJ10oKSA6IHJlcyksXG4gICAgICAgICAgICBkZWJvdW5jZVRpbWUoNTAwKSxcbiAgICAgICAgICAgIGRpc3RpbmN0VW50aWxDaGFuZ2VkKCksXG4gICAgICAgICAgICBtYXAoanNvbiA9PiBIdHRwQWN0aW9ucy5tYXRjaFBhdGgocGF0aCwganNvbikpLFxuICAgICAgICAgICAgY2F0Y2hFcnJvcihlcnIgPT4gdGhpcy5vbkVycm9yKGVycikpLFxuICAgICAgICAgICAgZmluYWxpemUoKCkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMub25Db21wbGV0ZSgnR0VUJywgdXJsKTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICk7XG4gICAgfTtcblxuICAgIC8qKlxuICAgICAqIE1ha2UgYSBQT1NUIHJlcXVlc3QuXG4gICAgICogQHBhcmFtIHJlbGF0aXZlUGF0aCBcbiAgICAgKiBAcGFyYW0gYm9keSBcbiAgICAgKiBAcGFyYW0gaGVhZGVycyBcbiAgICAgKiBAcGFyYW0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBwb3N0KHJlbGF0aXZlUGF0aDogc3RyaW5nLCBib2R5OiBhbnksIGhlYWRlcnMgPSB7fSwgb3B0aW9uczogSHR0cE9wdGlvbnMgPSBuZXcgSHR0cE9wdGlvbnMoKSk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgICAgIGNvbnN0IHVybCA9IG9wdGlvbnMucHJlcGVuZEJhc2VVcmwgPyB0aGlzLmZvcm1hdFVybChyZWxhdGl2ZVBhdGgpIDogcmVsYXRpdmVQYXRoO1xuICAgICAgICBjb25zdCBodHRwSGVhZGVycyA9IHRoaXMuYXBwZW5kSGVhZGVycyhoZWFkZXJzKTtcbiAgICAgICAgY29uc3Qgb2JzID0gdGhpcy5odHRwLnBvc3QodXJsLCBzZXJpYWxpemUoYm9keSksIHtcbiAgICAgICAgICAgIGhlYWRlcnM6IGh0dHBIZWFkZXJzXG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gb2JzLnBpcGUoXG4gICAgICAgICAgICBtYXAocmVzID0+IHJlcyAmJiByZXNbJ2pzb24nXSAmJiB0eXBlb2YgcmVzWydqc29uJ10gPT09ICdmdW5jdGlvbicgPyByZXNbJ2pzb24nXSgpIDogcmVzKSxcbiAgICAgICAgICAgIGNhdGNoRXJyb3IoZXJyID0+IHRoaXMub25FcnJvcihlcnIpKSxcbiAgICAgICAgICAgIGZpbmFsaXplKCgpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLm9uQ29tcGxldGUoJ1BPU1QnLCB1cmwpO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBNYWtlIGEgUE9TVCByZXF1ZXN0IHdpdGggZm9ybSB1cmwtZW5jb2RlZCBjb250ZW50IHR5cGUuXG4gICAgICogQHBhcmFtIHJlbGF0aXZlUGF0aCBcbiAgICAgKiBAcGFyYW0gYm9keSBcbiAgICAgKiBAcGFyYW0gaGVhZGVycyBcbiAgICAgKiBAcGFyYW0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBwb3N0Rm9ybVVybEVuY29kZWQocmVsYXRpdmVQYXRoOiBzdHJpbmcsIGJvZHk6IGFueSwgaGVhZGVycyA9IHt9LCBvcHRpb25zOiBIdHRwT3B0aW9ucyA9IG5ldyBIdHRwT3B0aW9ucygpKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICAgICAgY29uc3QgdXJsID0gb3B0aW9ucy5wcmVwZW5kQmFzZVVybCA/IHRoaXMuZm9ybWF0VXJsKHJlbGF0aXZlUGF0aCkgOiByZWxhdGl2ZVBhdGg7XG4gICAgICAgIGNvbnN0IGh0dHBIZWFkZXJzID0gbmV3IEh0dHBIZWFkZXJzKHsgJ2NvbnRlbnQtdHlwZSc6ICdhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQnIH0pO1xuICAgICAgICBjb25zdCBvYnMgPSB0aGlzLmh0dHAucG9zdCh1cmwsIGJvZHksIHtcbiAgICAgICAgICAgIGhlYWRlcnM6IGh0dHBIZWFkZXJzXG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gb2JzLnBpcGUoXG4gICAgICAgICAgICBtYXAocmVzID0+IHJlcyAmJiByZXNbJ2pzb24nXSAmJiB0eXBlb2YgcmVzWydqc29uJ10gPT09ICdmdW5jdGlvbicgPyByZXNbJ2pzb24nXSgpIDogcmVzKSxcbiAgICAgICAgICAgIGNhdGNoRXJyb3IoZXJyID0+IHRoaXMub25FcnJvcihlcnIpKSxcbiAgICAgICAgICAgIGZpbmFsaXplKCgpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLm9uQ29tcGxldGUoJ1BPU1QgRk9STSBVUkwtRU5DT0RFRCcsIHVybCk7XG4gICAgICAgICAgICB9KVxuICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIE1ha2UgYSBQVVQgcmVxdWVzdC5cbiAgICAgKiBAcGFyYW0gcmVsYXRpdmVQYXRoIFxuICAgICAqIEBwYXJhbSBib2R5IFxuICAgICAqIEBwYXJhbSBoZWFkZXJzIFxuICAgICAqIEBwYXJhbSBvcHRpb25zIFxuICAgICAqL1xuICAgIHB1dChyZWxhdGl2ZVBhdGg6IHN0cmluZywgYm9keTogYW55LCBoZWFkZXJzID0ge30sIG9wdGlvbnM6IEh0dHBPcHRpb25zID0gbmV3IEh0dHBPcHRpb25zKCkpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgICAgICBjb25zdCB1cmwgPSBvcHRpb25zLnByZXBlbmRCYXNlVXJsID8gdGhpcy5mb3JtYXRVcmwocmVsYXRpdmVQYXRoKSA6IHJlbGF0aXZlUGF0aDtcbiAgICAgICAgY29uc3QgaHR0cEhlYWRlcnMgPSB0aGlzLmFwcGVuZEhlYWRlcnMoaGVhZGVycyk7XG4gICAgICAgIGNvbnN0IG9icyA9IHRoaXMuaHR0cC5wdXQodXJsLCBzZXJpYWxpemUoYm9keSksIHtcbiAgICAgICAgICAgIGhlYWRlcnM6IGh0dHBIZWFkZXJzXG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gb2JzLnBpcGUoXG4gICAgICAgICAgICBtYXAocmVzID0+IHJlcyAmJiByZXNbJ2pzb24nXSAmJiB0eXBlb2YgcmVzWydqc29uJ10gPT09ICdmdW5jdGlvbicgPyByZXNbJ2pzb24nXSgpIDogcmVzKSxcbiAgICAgICAgICAgIGNhdGNoRXJyb3IoZXJyID0+IHRoaXMub25FcnJvcihlcnIpKSxcbiAgICAgICAgICAgIGZpbmFsaXplKCgpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLm9uQ29tcGxldGUoJ1BVVCcsIHVybCk7XG4gICAgICAgICAgICB9KVxuICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFRoaXMgbWV0aG9kIHdpbGwgYmUgdXNlZCB0byBmb3JtYXQgVVJMcyBmb3IgYWxsIGNyb3NzLW9yaWdpbiByZXF1ZXN0cy5cbiAgICAgKi9cbiAgICBmb3JtYXRVcmwocGF0aDogc3RyaW5nKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIGAke3RoaXMuYmFzZVVybH0vJHtwYXRofWA7XG4gICAgfVxuXG4gICAgLyoqIFxuICAgICAqIFVzZSB0aGlzIG1ldGhvZCB3aGVuIGEgcHJvbWlzZSBpcyBwcmVmZXJyZWQgb3ZlciBhbiBvYnNlcnZhYmxlLlxuICAgICAqL1xuICAgIGdldFByb21pc2UodXJsOiBzdHJpbmcpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0KHVybClcbiAgICAgICAgICAgIC50b1Byb21pc2UoKVxuICAgICAgICAgICAgLnRoZW4ocmVzID0+IHJlcy5qc29uKCkpO1xuICAgIH1cblxuICAgIHByaXZhdGUgb25FcnJvcihlcnJvcjogYW55KSB7XG4gICAgICAgIGxldCBlcnJvckJvZHk6IGFueTtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGVycm9yQm9keSA9IChlcnJvci5fYm9keSkgPyBKU09OLnBhcnNlKGVycm9yLl9ib2R5KSA6IHsgbWVzc2FnZTogJ0ludGVybmFsIHNlcnZlciBlcnJvcicsIHN0YXR1c0NvZGU6IGVycm9yLnN0YXR1cyB9O1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICBpZiAoZXJyb3Iuc3RhdHVzIDw9IDApIHtcbiAgICAgICAgICAgICAgICBlcnJvckJvZHkgPSB7IG1lc3NhZ2U6ICdJbnRlcm5hbCBzZXJ2ZXIgZXJyb3IuJywgc3RhdHVzQ29kZTogNTAwIH07XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGVycm9yQm9keS5tZXNzYWdlKSB7XG4gICAgICAgICAgICBlcnJvckJvZHkubWVzc2FnZSA9IGVycm9yQm9keS5tZXNzYWdlLnJlcGxhY2UoJ0FuIGVycm9yIGhhcyBvY2N1cmVkIGluIHRoZSBhcGkuU3lzdGVtLkV4Y2VwdGlvbjogJywgJycpO1xuICAgICAgICAgICAgZXJyb3JCb2R5Lm1lc3NhZ2UgPSBlcnJvckJvZHkubWVzc2FnZS5zdWJzdHJpbmcoMCwgZXJyb3JCb2R5Lm1lc3NhZ2UuaW5kZXhPZignIGF0JykpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aHJvd0Vycm9yKGVycm9yQm9keSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBvbkNvbXBsZXRlKG1ldGhvZDogc3RyaW5nLCB1cmw6IHN0cmluZyk6IHZvaWQge1xuICAgICAgICBpZiAodGhpcy5sb2dFdmVudHMpIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBDb21wbGV0ZWQgJHttZXRob2R9IHJlcXVlc3QgdG8gJHt1cmx9YCk7XG4gICAgICAgIH1cbiAgICB9XG5cbn1cbiJdfQ==
/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes} checked by tsc
 */
import { Tile } from '../tile/tile.model';
import { Dimensions } from '../../shared/models';
import { integerArray, positiveIntegerArray } from '../../shared/utils';
export class Collage {
    constructor() {
        this.canvasHeight = 0;
        this.canvasWidth = 0;
        this.maxColumns = 4;
        this.maxRows = 4;
        this.totalColumns = 0;
        this.totalRows = 0;
        this._images = [];
        this._tiles = [];
    }
    /**
     * @param {?} startRow
     * @param {?} startColumn
     * @param {?} maxColumns
     * @param {?} cells
     * @return {?}
     */
    static AvailableColumns(startRow, startColumn, maxColumns, cells) {
        const /** @type {?} */ totalColumns = cells[0].length;
        return Math.max(...positiveIntegerArray(maxColumns)
            .map(k => k <= maxColumns && startColumn + k <= totalColumns && cells[startRow] && cells[startRow][startColumn + k] ? k : 1));
    }
    /**
     * @param {?} startRow
     * @param {?} startColumn
     * @param {?} maxRows
     * @param {?} cells
     * @return {?}
     */
    static AvailableRows(startRow, startColumn, maxRows, cells) {
        const /** @type {?} */ totalRows = cells[0].length;
        return Math.max(...positiveIntegerArray(maxRows)
            .map(k => k <= maxRows && startRow + k <= totalRows && cells[startRow + k] && cells[startRow + k][startColumn] ? k : 1));
    }
    /**
     * @param {?} dimensions
     * @param {?} startRow
     * @param {?} startColumn
     * @param {?} maxRows
     * @param {?} maxColumns
     * @param {?} cells
     * @return {?}
     */
    static AvailableDimensions(dimensions, startRow, startColumn, maxRows, maxColumns, cells) {
        const /** @type {?} */ availableRows = Collage.AvailableRows(startRow, startColumn, maxRows, cells);
        const /** @type {?} */ availableColumns = Collage.AvailableColumns(startRow, startColumn, maxColumns, cells);
        return dimensions.filter(x => x.rows <= availableRows && x.columns <= availableColumns);
    }
    /**
     * @param {?} images
     * @param {?} canvasHeight
     * @param {?} canvasWidth
     * @param {?=} totalRows
     * @param {?=} totalColumns
     * @param {?=} maxRows
     * @param {?=} maxColumns
     * @return {?}
     */
    static Build(images, canvasHeight, canvasWidth, totalRows = 0, totalColumns = 0, maxRows = 0, maxColumns = 0) {
        const /** @type {?} */ collage = Object.assign(new Collage(), {
            canvasHeight,
            canvasWidth,
            totalRows,
            totalColumns,
            maxRows,
            maxColumns
        });
        collage.images = images;
        return collage;
    }
    /**
     * @param {?} rows
     * @param {?} cols
     * @return {?}
     */
    static BuildEmptyCells(rows, cols) {
        return integerArray(rows).map(x => integerArray(cols).map(y => true));
    }
    /**
     * @param {?} collage
     * @return {?}
     */
    static BuildTiles(collage) {
        return collage.images.map((image, index) => {
            const /** @type {?} */ dimensions = Collage.FindDimensions(image.height, image.width, collage.tileDimensions, collage.cellHeight, collage.cellWidth);
            return Object.assign(new Tile(), {
                image,
                dimensions,
                id: index + 1,
                cellHeight: collage.cellHeight,
                cellWidth: collage.cellWidth
            });
        });
    }
    /**
     * @param {?} id
     * @param {?} tileIds
     * @return {?}
     */
    static ChooseTileId(id, tileIds) {
        return [...tileIds.filter(x => x !== id), id];
    }
    /**
     * @param {?} index
     * @param {?} totalRows
     * @param {?} totalColumns
     * @return {?}
     */
    static FindCoordinates(index, totalRows, totalColumns) {
        const /** @type {?} */ remainder = (index + totalColumns) % totalColumns;
        return {
            row: (index - remainder) / totalColumns,
            column: remainder
        };
    }
    /**
     * @param {?} index
     * @param {?} totalRows
     * @param {?} totalColumns
     * @param {?} startRow
     * @param {?} startColumn
     * @return {?}
     */
    static FindCoordinatesNested(index, totalRows, totalColumns, startRow, startColumn) {
        const /** @type {?} */ coordinates = Collage.FindCoordinates(index, totalRows, totalColumns);
        coordinates.column += startColumn;
        coordinates.row += startRow;
        return coordinates;
    }
    /**
     * @param {?} height
     * @param {?} width
     * @param {?} dimensions
     * @param {?} cellHeight
     * @param {?} cellWidth
     * @return {?}
     */
    static FindDimensions(height, width, dimensions, cellHeight, cellWidth) {
        const /** @type {?} */ filtered = dimensions.filter(x => x.rows * cellHeight <= height && x.columns * cellWidth <= width);
        const /** @type {?} */ ordered = filtered.sort((a, b) => Math.abs(height / width - a.ratio) - Math.abs(height / width - b.ratio));
        const /** @type {?} */ closestMatch = ordered[0];
        const /** @type {?} */ rows = closestMatch && closestMatch.rows ? closestMatch.rows : [];
        const /** @type {?} */ columns = closestMatch && closestMatch.columns ? closestMatch.columns : [];
        return Object.assign(new Dimensions(), {
            rows,
            columns,
            height,
            width
        });
    }
    /**
     * @param {?} tiles
     * @param {?} tileIds
     * @param {?} dimensions
     * @return {?}
     */
    static FindNextTileId(tiles, tileIds, dimensions) {
        const /** @type {?} */ nextMatch = Collage.FindNextMatchId(tiles, tileIds, dimensions);
        return nextMatch || Collage.FindBestMatchId(tiles, tileIds, dimensions);
    }
    /**
     * @param {?} tiles
     * @param {?} tileIds
     * @param {?} dimensions
     * @return {?}
     */
    static FindBestMatchId(tiles, tileIds, dimensions) {
        let /** @type {?} */ diff = 999;
        return tileIds.reduce((acc, id) => {
            const /** @type {?} */ tile = tiles.find(x => x.id === id);
            diff = Math.abs(tile.ratio - dimensions.ratio);
            return acc === 0 || diff < acc ? id : acc;
        }, 0);
    }
    /**
     * @param {?} tiles
     * @param {?} tileIds
     * @param {?} dimensions
     * @return {?}
     */
    static FindNextMatchId(tiles, tileIds, dimensions) {
        return tileIds.reduce((acc, id) => {
            if (acc !== 0) {
                return acc;
            }
            const /** @type {?} */ tile = tiles.find(x => x.id === id);
            return tile && tile.rows === dimensions.rows && tile.columns === dimensions.columns ? tile.id : 0;
        }, 0);
    }
    /**
     * @param {?} tiles
     * @param {?} tileIds
     * @param {?} dimensions
     * @return {?}
     */
    static FindBestMatch(tiles, tileIds, dimensions) {
        const /** @type {?} */ id = Collage.FindBestMatchId(tiles, tileIds, dimensions);
        return tiles.find(x => x.id === id);
    }
    /**
     * @param {?} tiles
     * @param {?} tileIds
     * @param {?} dimensions
     * @return {?}
     */
    static FindNextTile(tiles, tileIds, dimensions) {
        return tileIds.reduce((acc, id) => {
            if (acc === null || acc.id === 0) {
                const /** @type {?} */ tile = tiles.find(x => x.id === id);
                const /** @type {?} */ dim = dimensions.find(x => tile.rows === x.rows && tile.columns === x.columns);
                return dim ? Object.assign(new Tile(), tile, {
                    dimensions: Object.assign(new Dimensions(), tile.dimensions, {
                        rows: dim.rows,
                        columns: dim.columns
                    })
                }) : null;
            }
            return acc;
        }, new Tile()) || Collage.FindBestMatch(tiles, tileIds, dimensions[0]);
    }
    /**
     * @param {?} cellHeight
     * @param {?} cellWidth
     * @param {?} maxRows
     * @param {?} maxColumns
     * @return {?}
     */
    static GetTileDimensions(cellHeight, cellWidth, maxRows, maxColumns) {
        return positiveIntegerArray(maxRows).reduce((acc, x) => {
            const /** @type {?} */ dimensions = positiveIntegerArray(maxColumns)
                .map(y => Object.assign(new Dimensions(), {
                rows: x,
                columns: y,
                height: x * cellHeight,
                width: y * cellWidth
            }));
            return [...acc, ...dimensions];
        }, []);
    }
    /**
     * @param {?} cells
     * @param {?} startIndex
     * @param {?} dimensions
     * @param {?} totalRows
     * @param {?} totalColumns
     * @return {?}
     */
    static MarkCellsAsFilled(cells, startIndex, dimensions, totalRows, totalColumns) {
        const /** @type {?} */ start = Collage.FindCoordinates(startIndex, totalRows, totalColumns);
        return integerArray(dimensions.rows * dimensions.columns).reduce((acc, i) => {
            const /** @type {?} */ coordinates = Collage.FindCoordinatesNested(i, dimensions.rows, dimensions.columns, start.row, start.column);
            cells[coordinates.row][coordinates.column] = false;
            return cells;
        }, cells);
    }
    /**
     * @param {?} tiles
     * @param {?} collage
     * @return {?}
     */
    static PositionTiles(tiles, collage) {
        let /** @type {?} */ cells = Collage.BuildEmptyCells(collage.totalRows, collage.totalColumns);
        let /** @type {?} */ tileIds = tiles.map(x => x.id);
        return integerArray(collage.totalCells).reduce((acc, i) => {
            const /** @type {?} */ coordinates = Collage.FindCoordinates(i, collage.totalRows, collage.totalColumns);
            if (!cells[coordinates.row][coordinates.column]) {
                return acc;
            }
            const /** @type {?} */ availableDimensions = Collage.AvailableDimensions(collage.tileDimensions, coordinates.row, coordinates.column, collage.maxRows, collage.maxColumns, cells);
            const /** @type {?} */ tile = Collage.FindNextTile(tiles, tileIds, availableDimensions);
            tile.coordinates = coordinates;
            cells = Collage.MarkCellsAsFilled(cells, i, tile.dimensions, collage.totalRows, collage.totalColumns);
            tileIds = Collage.ChooseTileId(tile.id, tileIds);
            return [...acc, tile];
        }, []);
    }
    /**
     * @return {?}
     */
    get cellHeight() {
        return this.canvasHeight / this.totalRows;
    }
    /**
     * @return {?}
     */
    get cellWidth() {
        return this.canvasWidth / this.totalColumns;
    }
    /**
     * @return {?}
     */
    get emptyCells() {
        return Collage.BuildEmptyCells(this.totalRows, this.totalColumns);
    }
    /**
     * @return {?}
     */
    get images() {
        return this._images;
    }
    /**
     * @param {?} value
     * @return {?}
     */
    set images(value) {
        this._images = value;
        this.tiles = Collage.BuildTiles(this);
    }
    /**
     * @return {?}
     */
    get tileDimensions() {
        return Collage.GetTileDimensions(this.cellHeight, this.cellWidth, this.maxRows, this.maxColumns);
    }
    /**
     * @return {?}
     */
    get tiles() {
        return this._tiles;
    }
    /**
     * @param {?} value
     * @return {?}
     */
    set tiles(value) {
        this._tiles = Collage.PositionTiles(value, this);
    }
    /**
     * @return {?}
     */
    get totalCells() {
        return this.totalRows * this.totalColumns;
    }
}
function Collage_tsickle_Closure_declarations() {
    /** @type {?} */
    Collage.prototype.canvasHeight;
    /** @type {?} */
    Collage.prototype.canvasWidth;
    /** @type {?} */
    Collage.prototype.maxColumns;
    /** @type {?} */
    Collage.prototype.maxRows;
    /** @type {?} */
    Collage.prototype.totalColumns;
    /** @type {?} */
    Collage.prototype.totalRows;
    /** @type {?} */
    Collage.prototype._images;
    /** @type {?} */
    Collage.prototype._tiles;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29sbGFnZS5tb2RlbC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BjYWl1L2xpYnJhcnkvIiwic291cmNlcyI6WyJsaWIvY29tcG9uZW50cy9jb2xsYWdlL2NvbGxhZ2UubW9kZWwudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUMxQyxPQUFPLEVBQVMsVUFBVSxFQUFlLE1BQU0scUJBQXFCLENBQUM7QUFDckUsT0FBTyxFQUFFLFlBQVksRUFBRSxvQkFBb0IsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBRXhFLE1BQU07OzRCQUNhLENBQUM7MkJBQ0YsQ0FBQzswQkFDRixDQUFDO3VCQUNKLENBQUM7NEJBQ0ksQ0FBQzt5QkFDSixDQUFDO3VCQUNNLEVBQUU7c0JBQ0osRUFBRTs7Ozs7Ozs7O0lBRW5CLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxRQUFnQixFQUFFLFdBQW1CLEVBQUUsVUFBa0IsRUFBRSxLQUFrQjtRQUNqRyx1QkFBTSxZQUFZLEdBQUcsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQztRQUNyQyxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLG9CQUFvQixDQUFDLFVBQVUsQ0FBQzthQUM5QyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLElBQUksVUFBVSxJQUFJLFdBQVcsR0FBRyxDQUFDLElBQUksWUFBWSxJQUFJLEtBQUssQ0FBQyxRQUFRLENBQUMsSUFBSSxLQUFLLENBQUMsUUFBUSxDQUFDLENBQUMsV0FBVyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7S0FDckk7Ozs7Ozs7O0lBRUQsTUFBTSxDQUFDLGFBQWEsQ0FBQyxRQUFnQixFQUFFLFdBQW1CLEVBQUUsT0FBZSxFQUFFLEtBQWtCO1FBQzNGLHVCQUFNLFNBQVMsR0FBRyxL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Q0FBQyxVQUFVLEVBQUUsSUFBSSxDQUFDLFNBQVMsRUFBRSxJQUFJLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQztLQUNwRzs7OztJQUVELElBQUksS0FBSztRQUNMLE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDO0tBQ3RCOzs7OztJQUVELElBQUksS0FBSyxDQUFDLEtBQWE7UUFDbkIsSUFBSSxDQUFDLE1BQU0sR0FBRyxPQUFPLENBQUMsYUFBYSxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsQ0FBQztLQUNwRDs7OztJQUVELElBQUksVUFBVTtRQUNWLE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUM7S0FDN0M7Q0FFSiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFRpbGUgfSBmcm9tICcuLi90aWxlL3RpbGUubW9kZWwnO1xyXG5pbXBvcnQgeyBJbWFnZSwgRGltZW5zaW9ucywgQ29vcmRpbmF0ZXMgfSBmcm9tICcuLi8uLi9zaGFyZWQvbW9kZWxzJztcclxuaW1wb3J0IHsgaW50ZWdlckFycmF5LCBwb3NpdGl2ZUludGVnZXJBcnJheSB9IGZyb20gJy4uLy4uL3NoYXJlZC91dGlscyc7XHJcblxyXG5leHBvcnQgY2xhc3MgQ29sbGFnZSB7XHJcbiAgICBjYW52YXNIZWlnaHQgPSAwO1xyXG4gICAgY2FudmFzV2lkdGggPSAwO1xyXG4gICAgbWF4Q29sdW1ucyA9IDQ7XHJcbiAgICBtYXhSb3dzID0gNDtcclxuICAgIHRvdGFsQ29sdW1ucyA9IDA7XHJcbiAgICB0b3RhbFJvd3MgPSAwO1xyXG4gICAgX2ltYWdlczogSW1hZ2VbXSA9IFtdO1xyXG4gICAgX3RpbGVzOiBUaWxlW10gPSBbXTtcclxuXHJcbiAgICBzdGF0aWMgQXZhaWxhYmxlQ29sdW1ucyhzdGFydFJvdzogbnVtYmVyLCBzdGFydENvbHVtbjogbnVtYmVyLCBtYXhDb2x1bW5zOiBudW1iZXIsIGNlbGxzOiBib29sZWFuW11bXSk6IG51bWJlciB7XHJcbiAgICAgICAgY29uc3QgdG90YWxDb2x1bW5zID0gY2VsbHNbMF0ubGVuZ3RoO1xyXG4gICAgICAgIHJldHVybiBNYXRoLm1heCguLi5wb3NpdGl2ZUludGVnZXJBcnJheShtYXhDb2x1bW5zKVxyXG4gICAgICAgICAgICAubWFwKGsgPT4gayA8PSBtYXhDb2x1bW5zICYmIHN0YXJ0Q29sdW1uICsgayA8PSB0b3RhbENvbHVtbnMgJiYgY2VsbHNbc3RhcnRSb3ddICYmIGNlbGxzW3N0YXJ0Um93XVtzdGFydENvbHVtbiArIGtdID8gayA6IDEpKTtcclxuICAgIH1cclxuXHJcbiAgICBzdGF0aWMgQXZhaWxhYmxlUm93cyhzdGFydFJvdzogbnVtYmVyLCBzdGFydENvbHVtbjogbnVtYmVyLCBtYXhSb3dzOiBudW1iZXIsIGNlbGxzOiBib29sZWFuW11bXSk6IG51bWJlciB7XHJcbiAgICAgICAgY29uc3QgdG90YWxSb3dzID0gY2VsbHNbMF0ubGVuZ3RoO1xyXG4gICAgICAgIHJldHVybiBNYXRoLm1heCguLi5wb3NpdGl2ZUludGVnZXJBcnJheShtYXhSb3dzKVxyXG4gICAgICAgICAgICAubWFwKGsgPT4gayA8PSBtYXhSb3dzICYmIHN0YXJ0Um93ICsgayA8PSB0b3RhbFJvd3MgJiYgY2VsbHNbc3RhcnRSb3cgKyBrXSAmJiBjZWxsc1tzdGFydFJvdyArIGtdW3N0YXJ0Q29sdW1uXSA/IGsgOiAxKSk7XHJcbiAgICB9XHJcblxyXG4gICAgc3RhdGljIEF2YWlsYWJsZURpbWVuc2lvbnMoXHJcbiAgICAgICAgZGltZW5zaW9uczogRGltZW5zaW9uc1tdLFxyXG4gICAgICAgIHN0YXJ0Um93OiBudW1iZXIsXHJcbiAgICAgICAgc3RhcnRDb2x1bW46IG51bWJlcixcclxuICAgICAgICBtYXhSb3dzOiBudW1iZXIsXHJcbiAgICAgICAgbWF4Q29sdW1uczogbnVtYmVyLFxyXG4gICAgICAgIGNlbGxzOiBib29sZWFuW11bXSk6IERpbWVuc2lvbnNbXSB7XHJcbiAgICAgICAgY29uc3QgYXZhaWxhYmxlUm93cyA9IENvbGxhZ2UuQXZhaWxhYmxlUm93cyhzdGFydFJvdywgc3RhcnRDb2x1bW4sIG1heFJvd3MsIGNlbGxzKTtcclxuICAgICAgICBjb25zdCBhdmFpbGFibGVDb2x1bW5zID0gQ29sbGFnZS5BdmFpbGFibGVDb2x1bW5zKHN0YXJ0Um93LCBzdGFydENvbHVtbiwgbWF4Q29sdW1ucywgY2VsbHMpO1xyXG4gICAgICAgIHJldHVybiBkaW1lbnNpb25zLmZpbHRlcih4ID0+IHgucm93cyA8PSBhdmFpbGFibGVSb3dzICYmIHguY29sdW1ucyA8PSBhdmFpbGFibGVDb2x1bW5zKTtcclxuICAgIH1cclxuXHJcbiAgICBzdGF0aWMgQnVpbGQoaW1hZ2VzOiBJbWFnZVtdLCBjYW52YXNIZWlnaHQsIGNhbnZhc1dpZHRoLCB0b3RhbFJvd3MgPSAwLCB0b3RhbENvbHVtbnMgPSAwLCBtYXhSb3dzID0gMCwgbWF4Q29sdW1ucyA9IDApOiBDb2xsYWdlIHtcclxuICAgICAgICBjb25zdCBjb2xsYWdlID0gT2JqZWN0LmFzc2lnbihuZXcgQ29sbGFnZSgpLCB7XHJcbiAgICAgICAgICAgIGNhbnZhc0hlaWdodCxcclxuICAgICAgICAgICAgY2FudmFzV2lkdGgsXHJcbiAgICAgICAgICAgIHRvdGFsUm93cyxcclxuICAgICAgICAgICAgdG90YWxDb2x1bW5zLFxyXG4gICAgICAgICAgICBtYXhSb3dzLFxyXG4gICAgICAgICAgICBtYXhDb2x1bW5zXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgY29sbGFnZS5pbWFnZXMgPSBpbWFnZXM7XHJcbiAgICAgICAgcmV0dXJuIGNvbGxhZ2U7XHJcbiAgICB9XHJcblxyXG4gICAgc3RhdGljIEJ1aWxkRW1wdHlDZWxscyhyb3dzOiBudW1iZXIsIGNvbHM6IG51bWJlcik6IGJvb2xlYW5bXVtdIHtcclxuICAgICAgICByZXR1cm4gaW50ZWdlckFycmF5KHJvd3MpLm1hcCh4ID0+IGludGVnZXJBcnJheShjb2xzKS5tYXAoeSA9PiB0cnVlKSk7XHJcbiAgICB9XHJcblxyXG4gICAgc3RhdGljIEJ1aWxkVGlsZXMoY29sbGFnZTogQ29sbGFnZSk6IFRpbGVbXSB7XHJcbiAgICAgICAgcmV0dXJuIGNvbGxhZ2UuaW1hZ2VzLm1hcCgoaW1hZ2UsIGluZGV4KSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IGRpbWVuc2lvbnMgPSBDb2xsYWdlLkZpbmREaW1lbnNpb25zKGltYWdlLmhlaWdodCwgaW1hZ2Uud2lkdGgsIGNvbGxhZ2UudGlsZURpbWVuc2lvbnMsIGNvbGxhZ2UuY2VsbEhlaWdodCwgY29sbGFnZS5jZWxsV2lkdGgpO1xyXG4gICAgICAgICAgICByZXR1cm4gT2JqZWN0LmFzc2lnbihuZXcgVGlsZSgpLCB7XHJcbiAgICAgICAgICAgICAgICBpbWFnZSxcclxuICAgICAgICAgICAgICAgIGRpbWVuc2lvbnMsXHJcbiAgICAgICAgICAgICAgICBpZDogaW5kZXggKyAxLFxyXG4gICAgICAgICAgICAgICAgY2VsbEhlaWdodDogY29sbGFnZS5jZWxsSGVpZ2h0LFxyXG4gICAgICAgICAgICAgICAgY2VsbFdpZHRoOiBjb2xsYWdlLmNlbGxXaWR0aFxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgKTtcclxuICAgIH1cclxuXHJcbiAgICBzdGF0aWMgQ2hvb3NlVGlsZUlkKGlkOiBudW1iZXIsIHRpbGVJZHM6IG51bWJlcltdKTogbnVtYmVyW10ge1xyXG4gICAgICAgIHJldHVybiBbLi4udGlsZUlkcy5maWx0ZXIoeCA9PiB4ICE9PSBpZCksIGlkXTtcclxuICAgIH1cclxuXHJcbiAgICBzdGF0aWMgRmluZENvb3JkaW5hdGVzKGluZGV4OiBudW1iZXIsIHRvdGFsUm93czogbnVtYmVyLCB0b3RhbENvbHVtbnM6IG51bWJlcik6IENvb3JkaW5hdGVzIHtcclxuICAgICAgICBjb25zdCByZW1haW5kZXIgPSAoaW5kZXggKyB0b3RhbENvbHVtbnMpICUgdG90YWxDb2x1bW5zO1xyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIHJvdzogKGluZGV4IC0gcmVtYWluZGVyKSAvIHRvdGFsQ29sdW1ucyxcclxuICAgICAgICAgICAgY29sdW1uOiByZW1haW5kZXJcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIHN0YXRpYyBGaW5kQ29vcmRpbmF0ZXNOZXN0ZWQoXHJcbiAgICAgICAgaW5kZXg6IG51bWJlciwgdG90YWxSb3dzOiBudW1iZXIsIHRvdGFsQ29sdW1uczogbnVtYmVyLCBzdGFydFJvdzogbnVtYmVyLCBzdGFydENvbHVtbjogbnVtYmVyKTogQ29vcmRpbmF0ZXMge1xyXG4gICAgICAgIGNvbnN0IGNvb3JkaW5hdGVzID0gQ29sbGFnZS5GaW5kQ29vcmRpbmF0ZXMoaW5kZXgsIHRvdGFsUm93cywgdG90YWxDb2x1bW5zKTtcclxuICAgICAgICBjb29yZGluYXRlcy5jb2x1bW4gKz0gc3RhcnRDb2x1bW47XHJcbiAgICAgICAgY29vcmRpbmF0ZXMucm93ICs9IHN0YXJ0Um93O1xyXG4gICAgICAgIHJldHVybiBjb29yZGluYXRlcztcclxuICAgIH1cclxuXHJcbiAgICBzdGF0aWMgRmluZERpbWVuc2lvbnMoaGVpZ2h0OiBudW1iZXIsIHdpZHRoOiBudW1iZXIsIGRpbWVuc2lvbnM6IERpbWVuc2lvbnNbXSwgY2VsbEhlaWdodDogbnVtYmVyLCBjZWxsV2lkdGg6IG51bWJlcik6IERpbWVuc2lvbnMge1xyXG4gICAgICAgIGNvbnN0IGZpbHRlcmVkID0gZGltZW5zaW9ucy5maWx0ZXIoeCA9PiB4LnJvd3MgKiBjZWxsSGVpZ2h0IDw9IGhlaWdodCAmJiB4LmNvbHVtbnMgKiBjZWxsV2lkdGggPD0gd2lkdGgpO1xyXG4gICAgICAgIGNvbnN0IG9yZGVyZWQgPSBmaWx0ZXJlZC5zb3J0KChhLCBiKSA9PiBNYXRoLmFicyhoZWlnaHQgLyB3aWR0aCAtIGEucmF0aW8pIC0gTWF0aC5hYnMoaGVpZ2h0IC8gd2lkdGggLSBiLnJhdGlvKSk7XHJcbiAgICAgICAgY29uc3QgY2xvc2VzdE1hdGNoID0gb3JkZXJlZFswXTtcclxuICAgICAgICBjb25zdCByb3dzID0gY2xvc2VzdE1hdGNoICYmIGNsb3Nlc3RNYXRjaC5yb3dzID8gY2xvc2VzdE1hdGNoLnJvd3MgOiBbXTtcclxuICAgICAgICBjb25zdCBjb2x1bW5zID0gY2xvc2VzdE1hdGNoICYmIGNsb3Nlc3RNYXRjaC5jb2x1bW5zID8gY2xvc2VzdE1hdGNoLmNvbHVtbnMgOiBbXTtcclxuICAgICAgICByZXR1cm4gT2JqZWN0LmFzc2lnbihuZXcgRGltZW5zaW9ucygpLCB7XHJcbiAgICAgICAgICAgIHJvd3MsXHJcbiAgICAgICAgICAgIGNvbHVtbnMsXHJcbiAgICAgICAgICAgIGhlaWdodCxcclxuICAgICAgICAgICAgd2lkdGhcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBzdGF0aWMgRmluZE5leHRUaWxlSWQodGlsZXM6IFRpbGVbXSwgdGlsZUlkczogbnVtYmVyW10sIGRpbWVuc2lvbnM6IERpbWVuc2lvbnMpOiBudW1iZXIge1xyXG4gICAgICAgIGNvbnN0IG5leHRNYXRjaCA9IENvbGxhZ2UuRmluZE5leHRNYXRjaElkKHRpbGVzLCB0aWxlSWRzLCBkaW1lbnNpb25zKTtcclxuICAgICAgICByZXR1cm4gbmV4dE1hdGNoIHx8IENvbGxhZ2UuRmluZEJlc3RNYXRjaElkKHRpbGVzLCB0aWxlSWRzLCBkaW1lbnNpb25zKTtcclxuICAgIH1cclxuXHJcbiAgICBzdGF0aWMgRmluZEJlc3RNYXRjaElkKHRpbGVzOiBUaWxlW10sIHRpbGVJZHM6IG51bWJlcltdLCBkaW1lbnNpb25zOiBEaW1lbnNpb25zKTogbnVtYmVyIHtcclxuICAgICAgICBsZXQgZGlmZiA9IDk5OTtcclxuICAgICAgICByZXR1cm4gdGlsZUlkcy5yZWR1Y2UoKGFjYywgaWQpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgdGlsZSA9IHRpbGVzLmZpbmQoeCA9PiB4LmlkID09PSBpZCk7XHJcbiAgICAgICAgICAgIGRpZmYgPSBNYXRoLmFicyh0aWxlLnJhdGlvIC0gZGltZW5zaW9ucy5yYXRpbyk7XHJcbiAgICAgICAgICAgIHJldHVybiBhY2MgPT09IDAgfHwgZGlmZiA8IGFjYyA/IGlkIDogYWNjO1xyXG4gICAgICAgIH0sIDApO1xyXG4gICAgfVxyXG5cclxuICAgIHN0YXRpYyBGaW5kTmV4dE1hdGNoSWQodGlsZXM6IFRpbGVbXSwgdGlsZUlkczogbnVtYmVyW10sIGRpbWVuc2lvbnM6IERpbWVuc2lvbnMpOiBudW1iZXIge1xyXG4gICAgICAgIHJldHVybiB0aWxlSWRzLnJlZHVjZSgoYWNjLCBpZCkgPT4ge1xyXG4gICAgICAgICAgICBpZiAoYWNjICE9PSAwKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gYWNjO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNvbnN0IHRpbGUgPSB0aWxlcy5maW5kKHggPT4geC5pZCA9PT0gaWQpO1xyXG4gICAgICAgICAgICByZXR1cm4gdGlsZSAmJiB0aWxlLnJvd3MgPT09IGRpbWVuc2lvbnMucm93cyAmJiB0aWxlLmNvbHVtbnMgPT09IGRpbWVuc2lvbnMuY29sdW1ucyA/IHRpbGUuaWQgOiAwO1xyXG4gICAgICAgIH0sIDApO1xyXG4gICAgfVxyXG5cclxuICAgIHN0YXRpYyBGaW5kQmVzdE1hdGNoKHRpbGVzOiBUaWxlW10sIHRpbGVJZHM6IG51bWJlcltdLCBkaW1lbnNpb25zOiBEaW1lbnNpb25zKTogVGlsZSB7XHJcbiAgICAgICAgY29uc3QgaWQgPSBDb2xsYWdlLkZpbmRCZXN0TWF0Y2hJZCh0aWxlcywgdGlsZUlkcywgZGltZW5zaW9ucyk7XHJcbiAgICAgICAgcmV0dXJuIHRpbGVzLmZpbmQoeCA9PiB4LmlkID09PSBpZCk7XHJcbiAgICB9XHJcblxyXG4gICAgc3RhdGljIEZpbmROZXh0VGlsZSh0aWxlczogVGlsZVtdLCB0aWxlSWRzOiBudW1iZXJbXSwgZGltZW5zaW9uczogRGltZW5zaW9uc1tdKTogVGlsZSB7XHJcbiAgICAgICAgcmV0dXJuIHRpbGVJZHMucmVkdWNlKChhY2MsIGlkKSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChhY2MgPT09IG51bGwgfHwgYWNjLmlkID09PSAwKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCB0aWxlID0gdGlsZXMuZmluZCh4ID0+IHguaWQgPT09IGlkKTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGRpbSA9IGRpbWVuc2lvbnMuZmluZCh4ID0+IHRpbGUucm93cyA9PT0geC5yb3dzICYmIHRpbGUuY29sdW1ucyA9PT0geC5jb2x1bW5zKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiBkaW0gPyBPYmplY3QuYXNzaWduKG5ldyBUaWxlKCksIHRpbGUsIHtcclxuICAgICAgICAgICAgICAgICAgICBkaW1lbnNpb25zOiBPYmplY3QuYXNzaWduKG5ldyBEaW1lbnNpb25zKCksIHRpbGUuZGltZW5zaW9ucywge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByb3dzOiBkaW0ucm93cyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29sdW1uczogZGltLmNvbHVtbnNcclxuICAgICAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgfSkgOiBudWxsO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiBhY2M7XHJcbiAgICAgICAgfSwgbmV3IFRpbGUoKSkgfHwgQ29sbGFnZS5GaW5kQmVzdE1hdGNoKHRpbGVzLCB0aWxlSWRzLCBkaW1lbnNpb25zWzBdKTtcclxuICAgIH1cclxuXHJcbiAgICBzdGF0aWMgR2V0VGlsZURpbWVuc2lvbnMoY2VsbEhlaWdodDogbnVtYmVyLCBjZWxsV2lkdGg6IG51bWJlciwgbWF4Um93czogbnVtYmVyLCBtYXhDb2x1bW5zOiBudW1iZXIpOiBEaW1lbnNpb25zW10ge1xyXG4gICAgICAgIHJldHVybiBwb3NpdGl2ZUludGVnZXJBcnJheShtYXhSb3dzKS5yZWR1Y2UoKGFjYywgeCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBkaW1lbnNpb25zID0gcG9zaXRpdmVJbnRlZ2VyQXJyYXkobWF4Q29sdW1ucylcclxuICAgICAgICAgICAgICAgIC5tYXAoeSA9PiBPYmplY3QuYXNzaWduKG5ldyBEaW1lbnNpb25zKCksIHtcclxuICAgICAgICAgICAgICAgICAgICByb3dzOiB4LFxyXG4gICAgICAgICAgICAgICAgICAgIGNvbHVtbnM6IHksXHJcbiAgICAgICAgICAgICAgICAgICAgaGVpZ2h0OiB4ICogY2VsbEhlaWdodCxcclxuICAgICAgICAgICAgICAgICAgICB3aWR0aDogeSAqIGNlbGxXaWR0aFxyXG4gICAgICAgICAgICAgICAgfSkpO1xyXG4gICAgICAgICAgICByZXR1cm4gWy4uLmFjYywgLi4uZGltZW5zaW9uc107XHJcbiAgICAgICAgfSwgW10pO1xyXG4gICAgfVxyXG5cclxuICAgIHN0YXRpYyBNYXJrQ2VsbHNBc0ZpbGxlZChjZWxsczogYm9vbGVhbltdW10sIHN0YXJ0SW5kZXg6IG51bWJlciwgZGltZW5zaW9uczogRGltZW5zaW9ucywgdG90YWxSb3dzOiBudW1iZXIsIHRvdGFsQ29sdW1uczogbnVtYmVyKTogYm9vbGVhbltdW10ge1xyXG4gICAgICAgIGNvbnN0IHN0YXJ0ID0gQ29sbGFnZS5GaW5kQ29vcmRpbmF0ZXMoc3RhcnRJbmRleCwgdG90YWxSb3dzLCB0b3RhbENvbHVtbnMpO1xyXG4gICAgICAgIHJldHVybiBpbnRlZ2VyQXJyYXkoZGltZW5zaW9ucy5yb3dzICogZGltZW5zaW9ucy5jb2x1bW5zKS5yZWR1Y2UoKGFjYywgaSkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBjb29yZGluYXRlcyA9IENvbGxhZ2UuRmluZENvb3JkaW5hdGVzTmVzdGVkKGksIGRpbWVuc2lvbnMucm93cywgZGltZW5zaW9ucy5jb2x1bW5zLCBzdGFydC5yb3csIHN0YXJ0LmNvbHVtbik7XHJcbiAgICAgICAgICAgIGNlbGxzW2Nvb3JkaW5hdGVzLnJvd11bY29vcmRpbmF0ZXMuY29sdW1uXSA9IGZhbHNlO1xyXG4gICAgICAgICAgICByZXR1cm4gY2VsbHM7XHJcbiAgICAgICAgfSwgY2VsbHMpO1xyXG4gICAgfVxyXG5cclxuICAgIHN0YXRpYyBQb3NpdGlvblRpbGVzKHRpbGVzOiBUaWxlW10sIGNvbGxhZ2U6IENvbGxhZ2UpOiBUaWxlW10ge1xyXG4gICAgICAgIGxldCBjZWxscyA9IENvbGxhZ2UuQnVpbGRFbXB0eUNlbGxzKGNvbGxhZ2UudG90YWxSb3dzLCBjb2xsYWdlLnRvdGFsQ29sdW1ucyk7XHJcbiAgICAgICAgbGV0IHRpbGVJZHMgPSB0aWxlcy5tYXAoeCA9PiB4LmlkKTtcclxuXHJcbiAgICAgICAgcmV0dXJuIGludGVnZXJBcnJheShjb2xsYWdlLnRvdGFsQ2VsbHMpLnJlZHVjZSgoYWNjLCBpKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IGNvb3JkaW5hdGVzID0gQ29sbGFnZS5GaW5kQ29vcmRpbmF0ZXMoaSwgY29sbGFnZS50b3RhbFJvd3MsIGNvbGxhZ2UudG90YWxDb2x1bW5zKTtcclxuICAgICAgICAgICAgaWYgKCFjZWxsc1tjb29yZGluYXRlcy5yb3ddW2Nvb3JkaW5hdGVzLmNvbHVtbl0pIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBhY2M7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY29uc3QgYXZhaWxhYmxlRGltZW5zaW9ucyA9IENvbGxhZ2UuQXZhaWxhYmxlRGltZW5zaW9ucyhjb2xsYWdlLnRpbGVEaW1lbnNpb25zLCBjb29yZGluYXRlcy5yb3csIGNvb3JkaW5hdGVzLmNvbHVtbiwgY29sbGFnZS5tYXhSb3dzLCBjb2xsYWdlLm1heENvbHVtbnMsIGNlbGxzKTtcclxuICAgICAgICAgICAgY29uc3QgdGlsZSA9IENvbGxhZ2UuRmluZE5leHRUaWxlKHRpbGVzLCB0aWxlSWRzLCBhdmFpbGFibGVEaW1lbnNpb25zKTtcclxuICAgICAgICAgICAgdGlsZS5jb29yZGluYXRlcyA9IGNvb3JkaW5hdGVzO1xyXG4gICAgICAgICAgICBjZWxscyA9IENvbGxhZ2UuTWFya0NlbGxzQXNGaWxsZWQoY2VsbHMsIGksIHRpbGUuZGltZW5zaW9ucywgY29sbGFnZS50b3RhbFJvd3MsIGNvbGxhZ2UudG90YWxDb2x1bW5zKTtcclxuICAgICAgICAgICAgdGlsZUlkcyA9IENvbGxhZ2UuQ2hvb3NlVGlsZUlkKHRpbGUuaWQsIHRpbGVJZHMpO1xyXG4gICAgICAgICAgICByZXR1cm4gWy4uLmFjYywgdGlsZV07XHJcbiAgICAgICAgfSwgW10pO1xyXG4gICAgfVxyXG5cclxuICAgIGdldCBjZWxsSGVpZ2h0KCk6IG51bWJlciB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuY2FudmFzSGVpZ2h0IC8gdGhpcy50b3RhbFJvd3M7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IGNlbGxXaWR0aCgpOiBudW1iZXIge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmNhbnZhc1dpZHRoIC8gdGhpcy50b3RhbENvbHVtbnM7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IGVtcHR5Q2VsbHMoKTogYm9vbGVhbltdW10ge1xyXG4gICAgICAgIHJldHVybiBDb2xsYWdlLkJ1aWxkRW1wdHlDZWxscyh0aGlzLnRvdGFsUm93cywgdGhpcy50b3RhbENvbHVtbnMpO1xyXG4gICAgfVxyXG5cclxuICAgIGdldCBpbWFnZXMoKTogSW1hZ2VbXSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX2ltYWdlcztcclxuICAgIH1cclxuXHJcbiAgICBzZXQgaW1hZ2VzKHZhbHVlOiBJbWFnZVtdKSB7XHJcbiAgICAgICAgdGhpcy5faW1hZ2VzID0gdmFsdWU7XHJcbiAgICAgICAgdGhpcy50aWxlcyA9IENvbGxhZ2UuQnVpbGRUaWxlcyh0aGlzKTtcclxuICAgIH1cclxuXHJcbiAgICBnZXQgdGlsZURpbWVuc2lvbnMoKTogRGltZW5zaW9uc1tdIHtcclxuICAgICAgICByZXR1cm4gQ29sbGFnZS5HZXRUaWxlRGltZW5zaW9ucyh0aGlzLmNlbGxIZWlnaHQsIHRoaXMuY2VsbFdpZHRoLCB0aGlzLm1heFJvd3MsIHRoaXMubWF4Q29sdW1ucyk7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IHRpbGVzKCk6IFRpbGVbXSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX3RpbGVzO1xyXG4gICAgfVxyXG5cclxuICAgIHNldCB0aWxlcyh2YWx1ZTogVGlsZVtdKSB7XHJcbiAgICAgICAgdGhpcy5fdGlsZXMgPSBDb2xsYWdlLlBvc2l0aW9uVGlsZXModmFsdWUsIHRoaXMpO1xyXG4gICAgfVxyXG5cclxuICAgIGdldCB0b3RhbENlbGxzKCk6IG51bWJlciB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMudG90YWxSb3dzICogdGhpcy50b3RhbENvbHVtbnM7XHJcbiAgICB9XHJcblxyXG59XHJcbiJdfQ==
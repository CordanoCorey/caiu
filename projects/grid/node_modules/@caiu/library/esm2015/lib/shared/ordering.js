/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes} checked by tsc
 */
import { build } from './utils';
/**
 * @template T
 */
export class Permutation {
    /**
     * @param {?} order
     */
    constructor(order) {
        this.order = order;
        this._timestamp = new Date();
    }
    /**
     * @return {?}
     */
    get ranks() {
        return this.order.sort((a, b) => a.order - b.order)
            .map((x, index) => Object.assign(/** @type {?} */ ({}), x, { rank: index + 1 }));
    }
    /**
     * @return {?}
     */
    get timestamp() {
        return this._timestamp;
    }
}
function Permutation_tsickle_Closure_declarations() {
    /** @type {?} */
    Permutation.prototype._timestamp;
    /** @type {?} */
    Permutation.prototype.order;
}
/**
 * @template T
 */
export class OrderedItem {
    /**
     * @param {?} item
     */
    constructor(item) {
        this.item = item;
    }
}
function OrderedItem_tsickle_Closure_declarations() {
    /** @type {?} */
    OrderedItem.prototype.id;
    /** @type {?} */
    OrderedItem.prototype.order;
    /** @type {?} */
    OrderedItem.prototype.rank;
    /** @type {?} */
    OrderedItem.prototype.item;
}
/**
 * @template T
 */
export class Ordering {
    /**
     * @param {?} _items
     * @param {?} ctor
     * @param {?} orderKey
     * @param {?=} idKey
     */
    constructor(_items, ctor, orderKey, idKey = 'id') {
        this._items = _items;
        this.ctor = ctor;
        this.orderKey = orderKey;
        this.idKey = idKey;
        this._history = [];
    }
    /**
     * @return {?}
     */
    get count() {
        return this.items.length;
    }
    /**
     * @return {?}
     */
    get history() {
        return this._history;
    }
    /**
     * @return {?}
     */
    get instance() {
        return new this.ctor();
    }
    /**
     * @return {?}
     */
    get items() {
        return this._items.sort((a, b) => this.getItemOrder(a) - this.getItemOrder(b));
    }
    /**
     * @return {?}
     */
    get maxIndex() {
        return this.count === 0 ? 0 : Math.max(...this.order.map(x => x.order));
    }
    /**
     * @return {?}
     */
    get order() {
        return this.permutation.ranks;
    }
    /**
     * @return {?}
     */
    get permutation() {
        return new Permutation(this.items.map(item => /** @type {?} */ ({
            id: this.getItemId(item),
            order: this.getItemOrder(item)
        })));
    }
    /**
     * @return {?}
     */
    get nextPosition() {
        return this.maxIndex + 1;
    }
    /**
     * @param {?} item
     * @return {?}
     */
    addItem(item) {
        return this.addItemAtPosition(item, this.nextPosition);
    }
    /**
     * @param {?} item
     * @param {?} pos
     * @return {?}
     */
    addItemAtPosition(item, pos) {
        const /** @type {?} */ newItemId = this.getItemId(item);
        return [...this.items, build(this.ctor, item, { order: pos })]
            .map(x => {
            const /** @type {?} */ order = this.getItemOrder(x);
            const /** @type {?} */ id = this.getItemId(x);
            return (order <= pos || id === newItemId) ? x : build(this.ctor, x, { order: order + 1 });
        });
    }
    /**
     * @param {?=} items
     * @return {?}
     */
    archive(items) {
        const /** @type {?} */ permutation = items ? this.getPermutation(items) : this.permutation;
        this._history = [...this._history, permutation];
    }
    /**
     * @param {?} item
     * @return {?}
     */
    getItemId(item) {
        return item[this.idKey];
    }
    /**
     * @param {?} item
     * @return {?}
     */
    getItemOrder(item) {
        return item[this.orderKey];
    }
    /**
     * @param {?} items
     * @return {?}
     */
    getPermutation(items) {
        return new Permutation(items.map(item => /** @type {?} */ ({
            id: this.getItemId(item),
            order: this.getItemOrder(item)
        })));
    }
    /**
     * @param {?} item
     * @param {?} to
     * @return {?}
     */
    move(item, to) {
        const /** @type {?} */ from = this.getItemOrder(item);
        const /** @type {?} */ itemId = this.getItemId(item);
        if (to === from) {
            return [...this.items];
        }
        else if (to < from) {
            return this.items.map(x => {
                const /** @type {?} */ order = this.getItemOrder(x);
                const /** @type {?} */ id = this.getItemId(x);
                return id === itemId ? build(this.ctor, x, { order: to })
                    : (order < to || order > from) ? x : build(this.ctor, x, { order: order + 1 });
            });
        }
        else {
            // to > from
            return this.items.map(x => {
                const /** @type {?} */ order = this.getItemOrder(x);
                const /** @type {?} */ id = this.getItemId(x);
                return id === itemId ? build(this.ctor, x, { order: to })
                    : (order < from || order > to) ? x : build(this.ctor, x, { order: order - 1 });
            });
        }
    }
    /**
     * @param {?} item
     * @return {?}
     */
    moveDown(item) {
        return this.move(item, this.getItemOrder(item) + 1);
    }
    /**
     * @param {?} item
     * @return {?}
     */
    moveUp(item) {
        return this.move(item, this.getItemOrder(item) - 1);
    }
    /**
     * @param {?} item
     * @return {?}
     */
    removeItem(item) {
        return this.removeItemAtPosition(this.getItemOrder(item));
    }
    /**
     * @param {?} pos
     * @return {?}
     */
    removeItemAtPosition(pos) {
        return this.items.filter(item => this.getItemOrder(item) !== pos)
            .map(x => {
            const /** @type {?} */ order = this.getItemOrder(x);
            return order < pos ? x : build(this.ctor, x, { order: order - 1 });
        });
    }
    /**
     * @param {?} items
     * @return {?}
     */
    updateItems(items) {
        this.archive();
        this._items = items;
    }
}
function Ordering_tsickle_Closure_declarations() {
    /** @type {?} */
    Ordering.prototype._history;
    /** @type {?} */
    Ordering.prototype._items;
    /** @type {?} */
    Ordering.prototype.ctor;
    /** @type {?} */
    Ordering.prototype.orderKey;
    /** @type {?} */
    Ordering.prototype.idKey;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib3JkZXJpbmcuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AY2FpdS9saWJyYXJ5LyIsInNvdXJjZXMiOlsibGliL3NoYXJlZC9vcmRlcmluZy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQ0EsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLFNBQVMsQ0FBQzs7OztBQUVoQyxNQUFNOzs7O0lBR0YsWUFBbUIsS0FBdUI7UUFBdkIsVUFBSyxHQUFMLEtBQUssQ0FBa0I7UUFDdEMsSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLElBQUksRUFBRSxDQUFDO0tBQ2hDOzs7O0lBRUQsSUFBSSxLQUFLO1FBQ0wsTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUMsS0FBSyxDQUFDO2FBQzlDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxLQUFLLEVBQUUsRUFBRSxDQUFDLE1BQU0sQ0FBQyxNQUFNLG1CQUFpQixFQUFFLEdBQUUsQ0FBQyxFQUFFLEVBQUUsSUFBSSxFQUFFLEtBQUssR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7S0FDckY7Ozs7SUFFRCxJQUFJLFNBQVM7UUFDVCxNQUFNLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQztLQUMxQjtDQUNKOzs7Ozs7Ozs7O0FBRUQsTUFBTTs7OztJQUtGLFlBQW1CLElBQU87UUFBUCxTQUFJLEdBQUosSUFBSSxDQUFHO0tBQ3pCO0NBQ0o7Ozs7Ozs7Ozs7Ozs7O0FBRUQsTUFBTTs7Ozs7OztJQUlGLFlBQW9CLE1BQVcsRUFBUyxJQUF3QixFQUFTLFFBQWdCLEVBQVMsUUFBUSxJQUFJO1FBQTFGLFdBQU0sR0FBTixNQUFNLENBQUs7UUFBUyxTQUFJLEdBQUosSUFBSSxDQUFvQjtRQUFTLGFBQVEsR0FBUixRQUFRLENBQVE7UUFBUyxVQUFLLEdBQUwsS0FBSyxDQUFPO3dCQUZ6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QUFJLEVBQUUsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztLQUN2RDs7Ozs7SUFFRCxNQUFNLENBQUMsSUFBTztRQUNWLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO0tBQ3ZEOzs7OztJQUVELFVBQVUsQ0FBQyxJQUFPO1FBQ2QsTUFBTSxDQUFDLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7S0FDN0Q7Ozs7O0lBRUQsb0JBQW9CLENBQUMsR0FBVztRQUM1QixNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxLQUFLLEdBQUcsQ0FBQzthQUM1RCxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUU7WUFDTCx1QkFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNuQyxNQUFNLENBQUMsS0FBSyxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDLEVBQUUsRUFBRSxLQUFLLEVBQUUsS0FBSyxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUM7U0FDdEUsQ0FBQyxDQUFDO0tBQ1Y7Ozs7O0lBRUQsV0FBVyxDQUFDLEtBQVU7UUFDbEIsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBQ2YsSUFBSSxDQUFDLE1BQU0sR0FBRyxLQUFLLENBQUM7S0FDdkI7Q0FDSiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFR5cGVDb25zdHJ1Y3RvciB9IGZyb20gJy4vbW9kZWxzJztcclxuaW1wb3J0IHsgYnVpbGQgfSBmcm9tICcuL3V0aWxzJztcclxuXHJcbmV4cG9ydCBjbGFzcyBQZXJtdXRhdGlvbjxUPiB7XHJcbiAgICBfdGltZXN0YW1wOiBEYXRlO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKHB1YmxpYyBvcmRlcjogT3JkZXJlZEl0ZW08VD5bXSkge1xyXG4gICAgICAgIHRoaXMuX3RpbWVzdGFtcCA9IG5ldyBEYXRlKCk7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IHJhbmtzKCk6IE9yZGVyZWRJdGVtPFQ+W10ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLm9yZGVyLnNvcnQoKGEsIGIpID0+IGEub3JkZXIgLSBiLm9yZGVyKVxyXG4gICAgICAgICAgICAubWFwKCh4LCBpbmRleCkgPT4gT2JqZWN0LmFzc2lnbig8T3JkZXJlZEl0ZW08VD4+e30sIHgsIHsgcmFuazogaW5kZXggKyAxIH0pKTtcclxuICAgIH1cclxuXHJcbiAgICBnZXQgdGltZXN0YW1wKCk6IERhdGUge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl90aW1lc3RhbXA7XHJcbiAgICB9XHJcbn1cclxuXHJcbmV4cG9ydCBjbGFzcyBPcmRlcmVkSXRlbTxUPiB7XHJcbiAgICBpZDogYW55O1xyXG4gICAgb3JkZXI6IG51bWJlcjtcclxuICAgIHJhbms/OiBudW1iZXI7XHJcblxyXG4gICAgY29uc3RydWN0b3IocHVibGljIGl0ZW06IFQpIHtcclxuICAgIH1cclxufVxyXG5cclxuZXhwb3J0IGNsYXNzIE9yZGVyaW5nPFQ+IHtcclxuXHJcbiAgICBwcml2YXRlIF9oaXN0b3J5OiBQZXJtdXRhdGlvbjxUPltdID0gW107XHJcblxyXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBfaXRlbXM6IFRbXSwgcHVibGljIGN0b3I6IFR5cGVDb25zdHJ1Y3RvcjxUPiwgcHVibGljIG9yZGVyS2V5OiBzdHJpbmcsIHB1YmxpYyBpZEtleSA9ICdpZCcpIHtcclxuICAgIH1cclxuXHJcbiAgICBnZXQgY291bnQoKTogbnVtYmVyIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5pdGVtcy5sZW5ndGg7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IGhpc3RvcnkoKTogUGVybXV0YXRpb248VD5bXSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX2hpc3Rvcnk7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IGluc3RhbmNlKCk6IFQge1xyXG4gICAgICAgIHJldHVybiBuZXcgdGhpcy5jdG9yKCk7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IGl0ZW1zKCk6IFRbXSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX2l0ZW1zLnNvcnQoKGEsIGIpID0+IHRoaXMuZ2V0SXRlbU9yZGVyKGEpIC0gdGhpcy5nZXRJdGVtT3JkZXIoYikpO1xyXG4gICAgfVxyXG5cclxuICAgIGdldCBtYXhJbmRleCgpOiBudW1iZXIge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmNvdW50ID09PSAwID8gMCA6IE1hdGgubWF4KC4uLnRoaXMub3JkZXIubWFwKHggPT4geC5vcmRlcikpO1xyXG4gICAgfVxyXG5cclxuICAgIGdldCBvcmRlcigpOiBPcmRlcmVkSXRlbTxUPltdIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5wZXJtdXRhdGlvbi5yYW5rcztcclxuICAgIH1cclxuXHJcbiAgICBnZXQgcGVybXV0YXRpb24oKTogUGVybXV0YXRpb248VD4ge1xyXG4gICAgICAgIHJldHVybiBuZXcgUGVybXV0YXRpb248VD4odGhpcy5pdGVtcy5tYXAoaXRlbSA9PiA8T3JkZXJlZEl0ZW08VD4+e1xyXG4gICAgICAgICAgICBpZDogdGhpcy5nZXRJdGVtSWQoaXRlbSksXHJcbiAgICAgICAgICAgIG9yZGVyOiB0aGlzLmdldEl0ZW1PcmRlcihpdGVtKVxyXG4gICAgICAgIH0pKTtcclxuICAgIH1cclxuXHJcbiAgICBnZXQgbmV4dFBvc2l0aW9uKCk6IG51bWJlciB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMubWF4SW5kZXggKyAxO1xyXG4gICAgfVxyXG5cclxuICAgIGFkZEl0ZW0oaXRlbTogVCk6IFRbXSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuYWRkSXRlbUF0UG9zaXRpb24oaXRlbSwgdGhpcy5uZXh0UG9zaXRpb24pO1xyXG4gICAgfVxyXG5cclxuICAgIGFkZEl0ZW1BdFBvc2l0aW9uKGl0ZW06IFQsIHBvczogbnVtYmVyKTogVFtdIHtcclxuICAgICAgICBjb25zdCBuZXdJdGVtSWQgPSB0aGlzLmdldEl0ZW1JZChpdGVtKTtcclxuICAgICAgICByZXR1cm4gWy4uLnRoaXMuaXRlbXMsIGJ1aWxkKHRoaXMuY3RvciwgaXRlbSwgeyBvcmRlcjogcG9zIH0pXVxyXG4gICAgICAgICAgICAubWFwKHggPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uc3Qgb3JkZXIgPSB0aGlzLmdldEl0ZW1PcmRlcih4KTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGlkID0gdGhpcy5nZXRJdGVtSWQoeCk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gKG9yZGVyIDw9IHBvcyB8fCBpZCA9PT0gbmV3SXRlbUlkKSA/IHggOiBidWlsZCh0aGlzLmN0b3IsIHgsIHsgb3JkZXI6IG9yZGVyICsgMSB9KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgYXJjaGl2ZShpdGVtcz86IFRbXSkge1xyXG4gICAgICAgIGNvbnN0IHBlcm11dGF0aW9uID0gaXRlbXMgPyB0aGlzLmdldFBlcm11dGF0aW9uKGl0ZW1zKSA6IHRoaXMucGVybXV0YXRpb247XHJcbiAgICAgICAgdGhpcy5faGlzdG9yeSA9IFsuLi50aGlzLl9oaXN0b3J5LCBwZXJtdXRhdGlvbl07XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0SXRlbUlkKGl0ZW06IFQpOiBhbnkge1xyXG4gICAgICAgIHJldHVybiBpdGVtW3RoaXMuaWRLZXldO1xyXG4gICAgfVxyXG5cclxuICAgIGdldEl0ZW1PcmRlcihpdGVtOiBUKTogbnVtYmVyIHtcclxuICAgICAgICByZXR1cm4gaXRlbVt0aGlzLm9yZGVyS2V5XTtcclxuICAgIH1cclxuXHJcbiAgICBnZXRQZXJtdXRhdGlvbihpdGVtczogVFtdKTogUGVybXV0YXRpb248VD4ge1xyXG4gICAgICAgIHJldHVybiBuZXcgUGVybXV0YXRpb24oaXRlbXMubWFwKGl0ZW0gPT4gPE9yZGVyZWRJdGVtPFQ+PntcclxuICAgICAgICAgICAgaWQ6IHRoaXMuZ2V0SXRlbUlkKGl0ZW0pLFxyXG4gICAgICAgICAgICBvcmRlcjogdGhpcy5nZXRJdGVtT3JkZXIoaXRlbSlcclxuICAgICAgICB9KSk7XHJcbiAgICB9XHJcblxyXG4gICAgbW92ZShpdGVtOiBULCB0bzogbnVtYmVyKTogVFtdIHtcclxuICAgICAgICBjb25zdCBmcm9tID0gdGhpcy5nZXRJdGVtT3JkZXIoaXRlbSk7XHJcbiAgICAgICAgY29uc3QgaXRlbUlkID0gdGhpcy5nZXRJdGVtSWQoaXRlbSk7XHJcbiAgICAgICAgaWYgKHRvID09PSBmcm9tKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBbLi4udGhpcy5pdGVtc107XHJcbiAgICAgICAgfSBlbHNlIGlmICh0byA8IGZyb20pIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuaXRlbXMubWFwKHggPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uc3Qgb3JkZXIgPSB0aGlzLmdldEl0ZW1PcmRlcih4KTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGlkID0gdGhpcy5nZXRJdGVtSWQoeCk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gaWQgPT09IGl0ZW1JZCA/IGJ1aWxkKHRoaXMuY3RvciwgeCwgeyBvcmRlcjogdG8gfSlcclxuICAgICAgICAgICAgICAgICAgICA6IChvcmRlciA8IHRvIHx8IG9yZGVyID4gZnJvbSkgPyB4IDogYnVpbGQodGhpcy5jdG9yLCB4LCB7IG9yZGVyOiBvcmRlciArIDEgfSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0gZWxzZSB7IC8vIHRvID4gZnJvbVxyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5pdGVtcy5tYXAoeCA9PiB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBvcmRlciA9IHRoaXMuZ2V0SXRlbU9yZGVyKHgpO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgaWQgPSB0aGlzLmdldEl0ZW1JZCh4KTtcclxuICAgICAgICAgICAgICAgIHJldHVybiBpZCA9PT0gaXRlbUlkID8gYnVpbGQodGhpcy5jdG9yLCB4LCB7IG9yZGVyOiB0byB9KVxyXG4gICAgICAgICAgICAgICAgICAgIDogKG9yZGVyIDwgZnJvbSB8fCBvcmRlciA+IHRvKSA/IHggOiBidWlsZCh0aGlzLmN0b3IsIHgsIHsgb3JkZXI6IG9yZGVyIC0gMSB9KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIG1vdmVEb3duKGl0ZW06IFQpOiBUW10ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLm1vdmUoaXRlbSwgdGhpcy5nZXRJdGVtT3JkZXIoaXRlbSkgKyAxKTtcclxuICAgIH1cclxuXHJcbiAgICBtb3ZlVXAoaXRlbTogVCk6IFRbXSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMubW92ZShpdGVtLCB0aGlzLmdldEl0ZW1PcmRlcihpdGVtKSAtIDEpO1xyXG4gICAgfVxyXG5cclxuICAgIHJlbW92ZUl0ZW0oaXRlbTogVCk6IFRbXSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMucmVtb3ZlSXRlbUF0UG9zaXRpb24odGhpcy5nZXRJdGVtT3JkZXIoaXRlbSkpO1xyXG4gICAgfVxyXG5cclxuICAgIHJlbW92ZUl0ZW1BdFBvc2l0aW9uKHBvczogbnVtYmVyKTogVFtdIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5pdGVtcy5maWx0ZXIoaXRlbSA9PiB0aGlzLmdldEl0ZW1PcmRlcihpdGVtKSAhPT0gcG9zKVxyXG4gICAgICAgICAgICAubWFwKHggPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uc3Qgb3JkZXIgPSB0aGlzLmdldEl0ZW1PcmRlcih4KTtcclxuICAgICAgICAgICAgICAgIHJldHVybiBvcmRlciA8IHBvcyA/IHggOiBidWlsZCh0aGlzLmN0b3IsIHgsIHsgb3JkZXI6IG9yZGVyIC0gMSB9KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgdXBkYXRlSXRlbXMoaXRlbXM6IFRbXSk6IHZvaWQge1xyXG4gICAgICAgIHRoaXMuYXJjaGl2ZSgpO1xyXG4gICAgICAgIHRoaXMuX2l0ZW1zID0gaXRlbXM7XHJcbiAgICB9XHJcbn1cclxuIl19
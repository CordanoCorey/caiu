/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes} checked by tsc
 */
import { FormBuilder } from '@angular/forms';
import { FormArray } from './models';
import { getAllProps, ignoreKey, inArray, build, getValue } from '../shared/utils';
/**
 * @param {?} fb
 * @param {?} value
 * @return {?}
 */
export function buildAbstractControl(fb, value) {
    return isGroupValue(value) ? fb.group(buildControlsConfig(value, fb)) : fb.control(value);
}
/**
 * Construct form builder and initialize new form array
 * @template T
 * @param {?} ctor
 * @param {?=} validator
 * @param {?=} asyncValidator
 * @return {?}
 */
export function buildArrayFromType(ctor, validator, asyncValidator) {
    var /** @type {?} */ fb = new FormBuilder();
    return FormArray.BuildWithType(ctor, fb, [], validator, asyncValidator);
}
/**
 * @param {?} fb
 * @param {?} model
 * @param {?} key
 * @return {?}
 */
export function buildControl(fb, model, key) {
    return isFormGroup(model, key) ?
        fb.group(buildControlsConfig(model[key], fb))
        : (isFormArray(model, key) ? buildFormArray(fb, model, key)
            : (hasValidators(model, key) ? [model[key], model['metadata'][key]['validators']]
                : [model[key]]));
}
/**
 * Construct form builder and initialize new form group.
 * @template T
 * @param {?} model
 * @return {?}
 */
export function buildControlFromModel(model) {
    var /** @type {?} */ fb = new FormBuilder();
    var /** @type {?} */ controlsConfig = buildControlsConfig(model, fb);
    return hasGroupValidators(model) ? fb.group(controlsConfig, model['metadata']['validators']) : fb.group(controlsConfig);
}
/**
 * Function to recursively construct form control config object.
 * @param {?} model
 * @param {?} fb
 * @return {?}
 */
export function buildControlsConfig(model, fb) {
    var /** @type {?} */ keys = getAllProps(model);
    var /** @type {?} */ config = {};
    return keys.filter(function (key) { return key !== 'metadata' && !ignoreKey(model, key); })
        .reduce(function (acc, key) {
        return Object.assign({}, acc, (_a = {}, _a[key] = buildControl(fb, model, key), _a));
        var _a;
    }, {});
}
/**
 * Initialize new form array.
 * @template T
 * @param {?} fb
 * @param {?} model
 * @param {?} key
 * @return {?}
 */
export function buildFormArray(fb, model, key) {
    var /** @type {?} */ ctor = findFormArrayType(model, key);
    var /** @type {?} */ value = model[key];
    var /** @type {?} */ controls = buildFormArrayControls(fb, value, ctor);
    return ctor ? FormArray.BuildWithType(ctor, fb, controls) : FormArray.Build(fb, []);
}
/**
 * @template T
 * @param {?} fb
 * @param {?} value
 * @param {?=} ctor
 * @return {?}
 */
export function buildFormArrayControls(fb, value, ctor) {
    return ctor ? value.map(function (x) { return buildAbstractControl(fb, getValue(build(ctor, x))); })
        : value.map(function (x) { return buildAbstractControl(fb, x); });
}
/**
 * @param {?} model
 * @param {?} key
 * @return {?}
 */
export function findFormArrayType(model, key) {
    return model['metadata'] && model['metadata'][key] ? /** @type {?} */ (model['metadata'][key]['type']) : null;
}
/**
 * @param {?} model
 * @return {?}
 */
export function hasGroupValidators(model) {
    return model['metadata'] && model['metadata']['validators'];
}
/**
 * @param {?} model
 * @param {?} key
 * @return {?}
 */
export function hasValidators(model, key) {
    return model['metadata'] && model['metadata'][key] && model['metadata'][key]['validators'];
}
/**
 * @param {?} value
 * @return {?}
 */
export function isArrayValue(value) {
    return Array.isArray(value);
}
/**
 * @param {?} model
 * @param {?} key
 * @return {?}
 */
export function isFormArray(model, key) {
    return Array.isArray(model[key]) && model['metadata'] && model['metadata'][key] && model['metadata'][key]['isFormArray'];
}
/**
 * @param {?} model
 * @param {?} key
 * @return {?}
 */
export function isFormControl(model, key) {
    return model['metadata'] && model['metadata']['controls'] && inArray(model['metadata']['controls'], key);
}
/**
 * @param {?} model
 * @param {?} key
 * @return {?}
 */
export function isFormGroup(model, key) {
    return model[key]
        && typeof model[key] === 'object'
        && !Array.isArray(model[key])
        && Object.keys(model[key]).length > 0
        && !isFormControl(model, key)
        && !isFormArray(model, key);
}
/**
 * @param {?} value
 * @return {?}
 */
export function isGroupValue(value) {
    return typeof value === 'object' && Object.keys(value).length > 0 && !isArrayValue(value);
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbHMuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AY2FpdS9saWJyYXJ5LyIsInNvdXJjZXMiOlsibGliL2Zvcm1zL3V0aWxzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQWEsV0FBVyxFQUErRCxNQUFNLGdCQUFnQixDQUFDO0FBRXJILE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFFckMsT0FBTyxFQUFFLFdBQVcsRUFBRSxTQUFTLEVBQUUsT0FBTyxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQzs7Ozs7O0FBRW5GLE1BQU0sK0JBQStCLEVBQWUsRUFBRSxLQUFVO0lBQzVELE1BQU0sQ0FBQyxZQUFZLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsbUJBQW1CLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7Q0FDN0Y7Ozs7Ozs7OztBQUtELE1BQU0sNkJBQWdDLElBQXdCLEVBQUUsU0FBdUIsRUFBRSxjQUFpQztJQUN0SCxxQkFBTSxFQUFFLEdBQUcsSUFBSSxXQUFXLEVBQUUsQ0FBQztJQUM3QixNQUFNLENBQUMsU0FBUyxDQUFDLGFBQWEsQ0FBQyxJQUFJLEVBQUUsRUFBRSxFQUFFLEVBQUUsRUFBRSxTQUFTLEVBQUUsY0FBYyxDQUFDLENBQUM7Q0FDM0U7Ozs7Ozs7QUFFRCxNQUFNLHVCQUF1QixFQUFlLEVBQUUsS0FBVSxFQUFFLEdBQVc7SUFDakUsTUFBTSxDQUFDLFdBQVcsQ0FBQyxLQUFLLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQztRQUM1QixFQUFFLENBQUMsS0FBSyxDQUFDLG1CQUFtQixDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztRQUM3QyxDQUFDLENBQUMsQ0FBQyxXQUFXLENBQUMs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QUFDLENBQUMsVUFBVSxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUM7Q0FDNUc7Ozs7OztBQUVELE1BQU0sc0JBQXNCLEtBQVUsRUFBRSxHQUFXO0lBQy9DLE1BQU0sQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDO1dBQ1YsT0FBTyxLQUFLLENBQUMsR0FBRyxDQUFDLEtBQUssUUFBUTtXQUM5QixDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1dBQzFCLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsTUFBTSxHQUFHLENBQUM7V0FDbEMsQ0FBQyxhQUFhLENBQUMsS0FBSyxFQUFFLEdBQUcsQ0FBQztXQUMxQixDQUFDLFdBQVcsQ0FBQyxLQUFLLEVBQUUsR0FBRyxDQUFDLENBQUM7Q0FDbkM7Ozs7O0FBRUQsTUFBTSx1QkFBdUIsS0FBVTtJQUNuQyxNQUFNLENBQUMsT0FBTyxLQUFLLEtBQUssUUFBUSxJQUFJLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsTUFBTSxHQUFHLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxLQUFLLENBQUMsQ0FBQztDQUM3RiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEZvcm1Hcm91cCwgRm9ybUJ1aWxkZXIsIEFic3RyYWN0Q29udHJvbCwgRm9ybUNvbnRyb2wsIFZhbGlkYXRvckZuLCBBc3luY1ZhbGlkYXRvckZuIH0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xyXG5cclxuaW1wb3J0IHsgRm9ybUFycmF5IH0gZnJvbSAnLi9tb2RlbHMnO1xyXG5pbXBvcnQgeyBEaWN0aW9uYXJ5LCBUeXBlQ29uc3RydWN0b3IgfSBmcm9tICcuLi9zaGFyZWQvbW9kZWxzJztcclxuaW1wb3J0IHsgZ2V0QWxsUHJvcHMsIGlnbm9yZUtleSwgaW5BcnJheSwgYnVpbGQsIGdldFZhbHVlIH0gZnJvbSAnLi4vc2hhcmVkL3V0aWxzJztcclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBidWlsZEFic3RyYWN0Q29udHJvbChmYjogRm9ybUJ1aWxkZXIsIHZhbHVlOiBhbnkpOiBGb3JtR3JvdXAgfCBGb3JtQXJyYXkgfCBGb3JtQ29udHJvbCB7XHJcbiAgICByZXR1cm4gaXNHcm91cFZhbHVlKHZhbHVlKSA/IGZiLmdyb3VwKGJ1aWxkQ29udHJvbHNDb25maWcodmFsdWUsIGZiKSkgOiBmYi5jb250cm9sKHZhbHVlKTtcclxufVxyXG5cclxuLyoqXHJcbiAqIENvbnN0cnVjdCBmb3JtIGJ1aWxkZXIgYW5kIGluaXRpYWxpemUgbmV3IGZvcm0gYXJyYXlcclxuICovXHJcbmV4cG9ydCBmdW5jdGlvbiBidWlsZEFycmF5RnJvbVR5cGU8VD4oY3RvcjogVHlwZUNvbnN0cnVjdG9yPFQ+LCB2YWxpZGF0b3I/OiBWYWxpZGF0b3JGbiwgYXN5bmNWYWxpZGF0b3I/OiBBc3luY1ZhbGlkYXRvckZuKTogRm9ybUFycmF5IHtcclxuICAgIGNvbnN0IGZiID0gbmV3IEZvcm1CdWlsZGVyKCk7XHJcbiAgICByZXR1cm4gRm9ybUFycmF5LkJ1aWxkV2l0aFR5cGUoY3RvciwgZmIsIFtdLCB2YWxpZGF0b3IsIGFzeW5jVmFsaWRhdG9yKTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGJ1aWxkQ29udHJvbChmYjogRm9ybUJ1aWxkZXIsIG1vZGVsOiBhbnksIGtleTogc3RyaW5nKTogRm9ybUdyb3VwIHwgRm9ybUFycmF5IHwgYW55W10ge1xyXG4gICAgcmV0dXJuIGlzRm9ybUdyb3VwKG1vZGVsLCBrZXkpID9cclxuICAgICAgICBmYi5ncm91cChidWlsZENvbnRyb2xzQ29uZmlnKG1vZGVsW2tleV0sIGZiKSlcclxuICAgICAgICA6IChpc0Zvcm1BcnJheShtb2RlbCwga2V5KSA/IGJ1aWxkRm9ybUFycmF5KGZiLCBtb2RlbCwga2V5KVxyXG4gICAgICAgICAgICA6IChoYXNWYWxpZGF0b3JzKG1vZGVsLCBrZXkpID8gW21vZGVsW2tleV0sIG1vZGVsWydtZXRhZGF0YSddW2tleV1bJ3ZhbGlkYXRvcnMnXV1cclxuICAgICAgICAgICAgICAgIDogW21vZGVsW2tleV1dKSk7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBDb25zdHJ1Y3QgZm9ybSBidWlsZGVyIGFuZCBpbml0aWFsaXplIG5ldyBmb3JtIGdyb3VwLlxyXG4gKi9cclxuZXhwb3J0IGZ1bmN0aW9uIGJ1aWxkQ29udHJvbEZyb21Nb2RlbDxUPihtb2RlbDogVCk6IEZvcm1Hcm91cCB7XHJcbiAgICBjb25zdCBmYiA9IG5ldyBGb3JtQnVpbGRlcigpO1xyXG4gICAgY29uc3QgY29udHJvbHNDb25maWcgPSBidWlsZENvbnRyb2xzQ29uZmlnKG1vZGVsLCBmYik7XHJcbiAgICByZXR1cm4gaGFzR3JvdXBWYWxpZGF0b3JzKG1vZGVsKSA/IGZiLmdyb3VwKGNvbnRyb2xzQ29uZmlnLCBtb2RlbFsnbWV0YWRhdGEnXVsndmFsaWRhdG9ycyddKSA6IGZiLmdyb3VwKGNvbnRyb2xzQ29uZmlnKTtcclxufVxyXG5cclxuLyoqXHJcbiAqIEZ1bmN0aW9uIHRvIHJlY3Vyc2l2ZWx5IGNvbnN0cnVjdCBmb3JtIGNvbnRyb2wgY29uZmlnIG9iamVjdC5cclxuICovXHJcbmV4cG9ydCBmdW5jdGlvbiBidWlsZENvbnRyb2xzQ29uZmlnKG1vZGVsOiBhbnksIGZiOiBGb3JtQnVpbGRlcik6IERpY3Rpb25hcnk8YW55PiB7XHJcbiAgICBjb25zdCBrZXlzID0gZ2V0QWxsUHJvcHMobW9kZWwpO1xyXG4gICAgY29uc3QgY29uZmlnOiBEaWN0aW9uYXJ5PGFueT4gPSB7fTtcclxuICAgIHJldHVybiBrZXlzLmZpbHRlcihrZXkgPT4ga2V5ICE9PSAnbWV0YWRhdGEnICYmICFpZ25vcmVLZXkobW9kZWwsIGtleSkpXHJcbiAgICAgICAgLnJlZHVjZSgoYWNjLCBrZXkpID0+IE9iamVjdC5hc3NpZ24oe30sIGFjYywgeyBba2V5XTogYnVpbGRDb250cm9sKGZiLCBtb2RlbCwga2V5KSB9KSwge30pO1xyXG59XHJcblxyXG4vKipcclxuICogSW5pdGlhbGl6ZSBuZXcgZm9ybSBhcnJheS5cclxuICovXHJcbmV4cG9ydCBmdW5jdGlvbiBidWlsZEZvcm1BcnJheTxUPihmYjogRm9ybUJ1aWxkZXIsIG1vZGVsOiBhbnksIGtleTogc3RyaW5nKTogRm9ybUFycmF5IHtcclxuICAgIGNvbnN0IGN0b3IgPSBmaW5kRm9ybUFycmF5VHlwZShtb2RlbCwga2V5KTtcclxuICAgIGNvbnN0IHZhbHVlID0gbW9kZWxba2V5XTtcclxuICAgIGNvbnN0IGNvbnRyb2xzID0gYnVpbGRGb3JtQXJyYXlDb250cm9scyhmYiwgdmFsdWUsIGN0b3IpO1xyXG4gICAgcmV0dXJuIGN0b3IgPyBGb3JtQXJyYXkuQnVpbGRXaXRoVHlwZShjdG9yLCBmYiwgY29udHJvbHMpIDogRm9ybUFycmF5LkJ1aWxkKGZiLCBbXSk7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBidWlsZEZvcm1BcnJheUNvbnRyb2xzPFQ+KGZiOiBGb3JtQnVpbGRlciwgdmFsdWU6IFRbXSwgY3Rvcj86IFR5cGVDb25zdHJ1Y3RvcjxUPik6IEFic3RyYWN0Q29udHJvbFtdIHtcclxuICAgIHJldHVybiBjdG9yID8gdmFsdWUubWFwKHggPT4gYnVpbGRBYnN0cmFjdENvbnRyb2woZmIsIGdldFZhbHVlKGJ1aWxkKGN0b3IsIHgpKSkpXHJcbiAgICAgICAgOiB2YWx1ZS5tYXAoeCA9PiBidWlsZEFic3RyYWN0Q29udHJvbChmYiwgeCkpO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZmluZEZvcm1BcnJheVR5cGUobW9kZWw6IGFueSwga2V5OiBzdHJpbmcpOiBUeXBlQ29uc3RydWN0b3I8YW55PiB7XHJcbiAgICByZXR1cm4gbW9kZWxbJ21ldGFkYXRhJ10gJiYgbW9kZWxbJ21ldGFkYXRhJ11ba2V5XSA/XHJcbiAgICAgICAgPFR5cGVDb25zdHJ1Y3Rvcjxhbnk+Pm1vZGVsWydtZXRhZGF0YSddW2tleV1bJ3R5cGUnXSA6IG51bGw7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBoYXNHcm91cFZhbGlkYXRvcnMobW9kZWw6IGFueSk6IGJvb2xlYW4ge1xyXG4gICAgcmV0dXJuIG1vZGVsWydtZXRhZGF0YSddICYmIG1vZGVsWydtZXRhZGF0YSddWyd2YWxpZGF0b3JzJ107XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBoYXNWYWxpZGF0b3JzKG1vZGVsOiBhbnksIGtleTogc3RyaW5nKTogYm9vbGVhbiB7XHJcbiAgICByZXR1cm4gbW9kZWxbJ21ldGFkYXRhJ10gJiYgbW9kZWxbJ21ldGFkYXRhJ11ba2V5XSAmJiBtb2RlbFsnbWV0YWRhdGEnXVtrZXldWyd2YWxpZGF0b3JzJ107XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBpc0FycmF5VmFsdWUodmFsdWU6IGFueSk6IGJvb2xlYW4ge1xyXG4gICAgcmV0dXJuIEFycmF5LmlzQXJyYXkodmFsdWUpO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gaXNGb3JtQXJyYXkobW9kZWw6IGFueSwga2V5OiBzdHJpbmcpOiBib29sZWFuIHtcclxuICAgIHJldHVybiBBcnJheS5pc0FycmF5KG1vZGVsW2tleV0pICYmIG1vZGVsWydtZXRhZGF0YSddICYmIG1vZGVsWydtZXRhZGF0YSddW2tleV0gJiYgbW9kZWxbJ21ldGFkYXRhJ11ba2V5XVsnaXNGb3JtQXJyYXknXTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGlzRm9ybUNvbnRyb2wobW9kZWw6IGFueSwga2V5OiBzdHJpbmcpOiBib29sZWFuIHtcclxuICAgIHJldHVybiBtb2RlbFsnbWV0YWRhdGEnXSAmJiBtb2RlbFsnbWV0YWRhdGEnXVsnY29udHJvbHMnXSAmJiBpbkFycmF5KG1vZGVsWydtZXRhZGF0YSddWydjb250cm9scyddLCBrZXkpO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gaXNGb3JtR3JvdXAobW9kZWw6IGFueSwga2V5OiBzdHJpbmcpOiBib29sZWFuIHtcclxuICAgIHJldHVybiBtb2RlbFtrZXldXHJcbiAgICAgICAgJiYgdHlwZW9mIG1vZGVsW2tleV0gPT09ICdvYmplY3QnXHJcbiAgICAgICAgJiYgIUFycmF5LmlzQXJyYXkobW9kZWxba2V5XSlcclxuICAgICAgICAmJiBPYmplY3Qua2V5cyhtb2RlbFtrZXldKS5sZW5ndGggPiAwXHJcbiAgICAgICAgJiYgIWlzRm9ybUNvbnRyb2wobW9kZWwsIGtleSlcclxuICAgICAgICAmJiAhaXNGb3JtQXJyYXkobW9kZWwsIGtleSk7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBpc0dyb3VwVmFsdWUodmFsdWU6IGFueSk6IGJvb2xlYW4ge1xyXG4gICAgcmV0dXJuIHR5cGVvZiB2YWx1ZSA9PT0gJ29iamVjdCcgJiYgT2JqZWN0LmtleXModmFsdWUpLmxlbmd0aCA+IDAgJiYgIWlzQXJyYXlWYWx1ZSh2YWx1ZSk7XHJcbn1cclxuIl19
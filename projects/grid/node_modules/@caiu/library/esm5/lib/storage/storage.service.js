/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes} checked by tsc
 */
import { Injectable, Inject } from '@angular/core';
import { Store } from '@ngrx/store';
import { StorageActions } from './storage.actions';
import { ActionStore } from './storage.models';
import { STORE_KEY } from './storage.module';
import { build, inArray, filterState } from '../shared/utils';
import * as i0 from "@angular/core";
import * as i1 from "@ngrx/store";
import * as i2 from "./storage.module";
var StorageService = /** @class */ (function () {
    function StorageService(store, storeKey) {
        this.store = store;
        this.storeKey = storeKey;
        this.localStorageActions = [];
        this.sessionStorageActions = [];
        this.localStorageMapper = function (s) { return s; };
        this.sessionStorageMapper = function (s) { return s; };
    }
    Object.defineProperty(StorageService.prototype, "localStore", {
        get: /**
         * @return {?}
         */
        function () {
            return localStorage.getItem(this.storeKey);
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(StorageService.prototype, "sessionStore", {
        get: /**
         * @return {?}
         */
        function () {
            return sessionStorage.getItem(this.storeKey);
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(StorageService.prototype, "storage", {
        get: /**
         * @return {?}
         */
        function () {
            var /** @type {?} */ localStore = this.localStore;
            var /** @type {?} */ sessionStore = this.sessionStore;
            return build(Storage, Object.assign({}, localStore, sessionStore), {
                localStore: localStore,
                sessionStore: sessionStore
            });
        },
        enumerable: true,
        configurable: true
    });
    /**
     * Initialize the use of local storage and/or session storage
     * @param localStorageMapper Mapper function for mapping state to local store
     * @param sessionStorageMapper Mapper function for mapping state to session store
     * @param localStorageActions Actions after which to save to local storage
     * @param sessionStorageActions Actions after which to save to session storage
     */
    /**
     * Initialize the use of local storage and/or session storage
     * @param {?=} localStorageMapper Mapper function for mapping state to local store
     * @param {?=} sessionStorageMapper Mapper function for mapping state to session store
     * @param {?=} localStorageActions Actions after which to save to local storage
     * @param {?=} sessionStorageActions Actions after which to save to session storage
     * @return {?}
     */
    StorageService.prototype.init = /**
     * Initialize the use of local storage and/or session storage
     * @param {?=} localStorageMapper Mapper function for mapping state to local store
     * @param {?=} sessionStorageMapper Mapper function for mapping state to session store
     * @param {?=} localStorageActions Actions after which to save to local storage
     * @param {?=} sessionStorageActions Actions after which to save to session storage
     * @return {?}
     */
    function (localStorageMapper, sessionStorageMapper, localStorageActions, sessionStorageActions) {
        if (localStorageMapper === void 0) { localStorageMapper = function (s) { return s; }; }
        if (sessionStorageMapper === void 0) { sessionStorageMapper = function (s) { return s; }; }
        if (localStorageActions === void 0) { localStorageActions = []; }
        if (sessionStorageActions === void 0) { sessionStorageActions = []; }
        var /** @type {?} */ localStore = this.initLocalStore(localStorageMapper, localStorageActions);
        var /** @type {?} */ sessionStore = this.initSessionStore(sessionStorageMapper, sessionStorageActions);
        this.store.dispatch(StorageActions.initStore(localStore, sessionStore));
    };
    /**
     * Initialize the use of local storage
     * @param localStorageMapper Mapper function for mapping state to local store
     * @param localStorageActions Actions after which to save to local storage
     */
    /**
     * Initialize the use of local storage
     * @param {?=} localStorageMapper Mapper function for mapping state to local store
     * @param {?=} localStorageActions Actions after which to save to local storage
     * @return {?}
     */
    StorageService.prototype.initLocalStore = /**
     * Initialize the use of local storage
     * @param {?=} localStorageMapper Mapper function for mapping state to local store
     * @param {?=} localStorageActions Actions after which to save to local storage
     * @return {?}
     */
    function (localStorageMapper, localStorageActions) {
        if (localStorageMapper === void 0) { localStorageMapper = function (s) { return s; }; }
        if (localStorageActions === void 0) { localStorageActions = []; }
        this.localStorageMapper = localStorageMapper;
        this.localStorageActions = localStorageActions;
        var /** @type {?} */ ls = this.localStore;
        var /** @type {?} */ localStore = ls ? JSON.parse(ls) : {};
        return localStore;
    };
    /**
     * Initialize the use of session storage
     * @param sessionStorageMapper Mapper function for mapping state to session store
     * @param sessionStorageActions Actions after which to save to session storage
     */
    /**
     * Initialize the use of session storage
     * @param {?=} sessionStorageMapper Mapper function for mapping state to session store
     * @param {?=} sessionStorageActions Actions after which to save to session storage
     * @return {?}
     */
    StorageService.prototype.initSessionStore = /**
     * Initialize the use of session storage
     * @param {?=} sessionStorageMapper Mapper function for mapping state to session store
     * @param {?=} sessionStorageActions Actions after which to save to session storage
     * @return {?}
     */
    function (sessionStorageMapper, sessionStorageActions) {
        if (sessionStorageMapper === void 0) { sessionStorageMapper = function (s) { return s; }; }
        if (sessionStorageActions === void 0) { sessionStorageActions = []; }
        this.sessionStorageMapper = sessionStorageMapper;
        this.sessionStorageActions = sessionStorageActions;
        var /** @type {?} */ ss = this.sessionStore;
        var /** @type {?} */ sessionStore = ss ? JSON.parse(ss) : {};
        return sessionStorage;
    };
    /**
     * @param {?} actionType
     * @return {?}
     */
    StorageService.prototype.inLocalStorage = /**
     * @param {?} actionType
     * @return {?}
     */
    function (actionType) {
        return inArray(this.localStorageActions, actionType);
    };
    /**
     * @param {?} actionType
     * @return {?}
     */
    StorageService.prototype.inSessionStorage = /**
     * @param {?} actionType
     * @return {?}
     */
    function (actionType) {
        return inArray(this.sessionStorageActions, actionType);
    };
    /**
     * Store state to local storage.
     */
    /**
     * Store state to local storage.
     * @param {?} state
     * @param {?} action
     * @return {?}
     */
    StorageService.prototype.storeLocal = /**
     * Store state to local storage.
     * @param {?} state
     * @param {?} action
     * @return {?}
     */
    function (state, action) {
        try {
            // const filteredState = new ActionStore(action, this.filterState(Object.assign({}, state)));
            var /** @type {?} */ filteredState = Object.assign(filterState(new ActionStore(action)), filterState(Object.assign({}, this.localStorageMapper(state))));
            var /** @type {?} */ serializedState = JSON.stringify(filteredState);
            localStorage.removeItem(this.storeKey);
            localStorage.setItem(this.storeKey, serializedState);
        }
        catch (/** @type {?} */ err) {
            console.error("ERROR SAVING LOCAL STATE!\nAction:\t" + action.actionType + "\n", err);
        }
    };
    /**
     * Store state to session storage.
     */
    /**
     * Store state to session storage.
     * @param {?} state
     * @param {?} action
     * @return {?}
     */
    StorageService.prototype.storeSession = /**
     * Store state to session storage.
     * @param {?} state
     * @param {?} action
     * @return {?}
     */
    function (state, action) {
        try {
            // const filteredState = new ActionStore(action, this.filterState(Object.assign({}, state)));
            // const filteredState = this.filterState(Object.assign({}, state));
            var /** @type {?} */ filteredState = Object.assign(filterState(new ActionStore(action)), filterState(Object.assign({}, this.sessionStorageMapper(state))));
            var /** @type {?} */ serializedState = JSON.stringify(filteredState);
            localStorage.removeItem(this.storeKey);
            sessionStorage.setItem(this.storeKey, serializedState);
        }
        catch (/** @type {?} */ err) {
            console.error("ERROR SAVING SESSION STATE!\nAction:\t" + action.actionType + "\n", err);
        }
    };
    StorageService.decorators = [
        { type: Injectable, args: [{
                    providedIn: 'root'
                },] },
    ];
    /** @nocollapse */
    StorageService.ctorParameters = function () { return [
        { type: Store },
        { type: String, decorators: [{ type: Inject, args: [STORE_KEY,] }] }
    ]; };
    /** @nocollapse */ StorageService.ngInjectableDef = i0.defineInjectable({ factory: function StorageService_Factory() { return new StorageService(i0.inject(i1.Store), i0.inject(i2.STORE_KEY)); }, token: StorageService, providedIn: "root" });
    return StorageService;
}());
export { StorageService };
function StorageService_tsickle_Closure_declarations() {
    /** @type {?} */
    StorageService.prototype.localStorageActions;
    /** @type {?} */
    StorageService.prototype.sessionStorageActions;
    /** @type {?} */
    StorageService.prototype.localStorageMapper;
    /** @type {?} */
    StorageService.prototype.sessionStorageMapper;
    /** @type {?} */
    StorageService.prototype.store;
    /** @type {?} */
    StorageService.prototype.storeKey;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RvcmFnZS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGNhaXUvbGlicmFyeS8iLCJzb3VyY2VzIjpbImxpYi9zdG9yYWdlL3N0b3JhZ2Uuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDbkQsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUVwQyxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDbkQsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQy9DLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUU3QyxPQUFPLEVBQUUsS0FBSyxFQUFFLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQzs7Ozs7SUFZNUQsd0JBQW1CLEtBQWlCLEVBQTRCLFFBQWdCO1FBQTdELFVBQUssR0FBTCxLQUFLLENBQVk7UUFBNEIsYUFBUSxHQUFSLFFBQVEsQ0FBUTttQ0FMaEQsRUFBRTtxQ0FDQSxFQUFFO2tDQUNNLFVBQUEsQ0FBQyxJQUFJLE9BQUEsQ0FBQyxFQUFELENBQUM7b0NBQ0osVUFBQSxDQUFDLElBQUksT0FBQSxDQUFDLEVBQUQsQ0FBQztLQUdqRDtJQUVELHNCQUFJLHNDQUFVOzs7O1FBQWQ7WUFDRSxNQUFNLENBQUMsWUFBWSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7U0FDNUM7OztPQUFBO0lBRUQsc0JBQUksd0NBQVk7Ozs7UUFBaEI7WUFDRSxNQUFNLENBQUMsY0FBYyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7U0FDOUM7OztPQUFBO0lBRUQsc0JBQUksbUNBQU87Ozs7UUFBWDtZQUNFLHFCQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDO1lBQ25DLHFC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TyxDQUFDLEtBQUssQ0FBQywyQ0FBeUMsTUFBTSxDQUFDLFVBQVUsT0FBSSxFQUFFLEdBQUcsQ0FBQyxDQUFDO1NBQ3BGO0tBQ0Y7O2dCQWhIRixVQUFVLFNBQUM7b0JBQ1YsVUFBVSxFQUFFLE1BQU07aUJBQ25COzs7O2dCQVZRLEtBQUs7NkNBa0IyQixNQUFNLFNBQUMsU0FBUzs7O3lCQW5CekQ7O1NBWWEsY0FBYyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIEluamVjdCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgU3RvcmUgfSBmcm9tICdAbmdyeC9zdG9yZSc7XG5cbmltcG9ydCB7IFN0b3JhZ2VBY3Rpb25zIH0gZnJvbSAnLi9zdG9yYWdlLmFjdGlvbnMnO1xuaW1wb3J0IHsgQWN0aW9uU3RvcmUgfSBmcm9tICcuL3N0b3JhZ2UubW9kZWxzJztcbmltcG9ydCB7IFNUT1JFX0tFWSB9IGZyb20gJy4vc3RvcmFnZS5tb2R1bGUnO1xuaW1wb3J0IHsgQWN0aW9uIH0gZnJvbSAnLi4vc3RvcmUvbW9kZWxzJztcbmltcG9ydCB7IGJ1aWxkLCBpbkFycmF5LCBmaWx0ZXJTdGF0ZSB9IGZyb20gJy4uL3NoYXJlZC91dGlscyc7XG5cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIFN0b3JhZ2VTZXJ2aWNlIHtcblxuICBsb2NhbFN0b3JhZ2VBY3Rpb25zOiBzdHJpbmdbXSA9IFtdO1xuICBzZXNzaW9uU3RvcmFnZUFjdGlvbnM6IHN0cmluZ1tdID0gW107XG4gIGxvY2FsU3RvcmFnZU1hcHBlcjogKHN0YXRlOiBhbnkpID0+IGFueSA9IHMgPT4gcztcbiAgc2Vzc2lvblN0b3JhZ2VNYXBwZXI6IChzdGF0ZTogYW55KSA9PiBhbnkgPSBzID0+IHM7XG5cbiAgY29uc3RydWN0b3IocHVibGljIHN0b3JlOiBTdG9yZTxhbnk+LCBASW5qZWN0KFNUT1JFX0tFWSkgcHVibGljIHN0b3JlS2V5OiBzdHJpbmcpIHtcbiAgfVxuXG4gIGdldCBsb2NhbFN0b3JlKCk6IGFueSB7XG4gICAgcmV0dXJuIGxvY2FsU3RvcmFnZS5nZXRJdGVtKHRoaXMuc3RvcmVLZXkpO1xuICB9XG5cbiAgZ2V0IHNlc3Npb25TdG9yZSgpOiBhbnkge1xuICAgIHJldHVybiBzZXNzaW9uU3RvcmFnZS5nZXRJdGVtKHRoaXMuc3RvcmVLZXkpO1xuICB9XG5cbiAgZ2V0IHN0b3JhZ2UoKTogU3RvcmFnZSB7XG4gICAgY29uc3QgbG9jYWxTdG9yZSA9IHRoaXMubG9jYWxTdG9yZTtcbiAgICBjb25zdCBzZXNzaW9uU3RvcmUgPSB0aGlzLnNlc3Npb25TdG9yZTtcbiAgICByZXR1cm4gYnVpbGQoU3RvcmFnZSwgT2JqZWN0LmFzc2lnbih7fSwgbG9jYWxTdG9yZSwgc2Vzc2lvblN0b3JlKSwge1xuICAgICAgbG9jYWxTdG9yZSxcbiAgICAgIHNlc3Npb25TdG9yZVxuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEluaXRpYWxpemUgdGhlIHVzZSBvZiBsb2NhbCBzdG9yYWdlIGFuZC9vciBzZXNzaW9uIHN0b3JhZ2VcbiAgICogQHBhcmFtIGxvY2FsU3RvcmFnZU1hcHBlciBNYXBwZXIgZnVuY3Rpb24gZm9yIG1hcHBpbmcgc3RhdGUgdG8gbG9jYWwgc3RvcmVcbiAgICogQHBhcmFtIHNlc3Npb25TdG9yYWdlTWFwcGVyIE1hcHBlciBmdW5jdGlvbiBmb3IgbWFwcGluZyBzdGF0ZSB0byBzZXNzaW9uIHN0b3JlXG4gICAqIEBwYXJhbSBsb2NhbFN0b3JhZ2VBY3Rpb25zIEFjdGlvbnMgYWZ0ZXIgd2hpY2ggdG8gc2F2ZSB0byBsb2NhbCBzdG9yYWdlXG4gICAqIEBwYXJhbSBzZXNzaW9uU3RvcmFnZUFjdGlvbnMgQWN0aW9ucyBhZnRlciB3aGljaCB0byBzYXZlIHRvIHNlc3Npb24gc3RvcmFnZVxuICAgKi9cbiAgaW5pdChsb2NhbFN0b3JhZ2VNYXBwZXI6IChzdGF0ZTogYW55KSA9PiBhbnkgPSBzID0+IHMsIHNlc3Npb25TdG9yYWdlTWFwcGVyOiAoc3RhdGU6IGFueSkgPT4gYW55ID0gcyA9PiBzLCBsb2NhbFN0b3JhZ2VBY3Rpb25zID0gW10sIHNlc3Npb25TdG9yYWdlQWN0aW9ucyA9IFtdKSB7XG4gICAgY29uc3QgbG9jYWxTdG9yZSA9IHRoaXMuaW5pdExvY2FsU3RvcmUobG9jYWxTdG9yYWdlTWFwcGVyLCBsb2NhbFN0b3JhZ2VBY3Rpb25zKTtcbiAgICBjb25zdCBzZXNzaW9uU3RvcmUgPSB0aGlzLmluaXRTZXNzaW9uU3RvcmUoc2Vzc2lvblN0b3JhZ2VNYXBwZXIsIHNlc3Npb25TdG9yYWdlQWN0aW9ucyk7XG4gICAgdGhpcy5zdG9yZS5kaXNwYXRjaChTdG9yYWdlQWN0aW9ucy5pbml0U3RvcmUobG9jYWxTdG9yZSwgc2Vzc2lvblN0b3JlKSk7XG4gIH1cblxuICAvKipcbiAgICogSW5pdGlhbGl6ZSB0aGUgdXNlIG9mIGxvY2FsIHN0b3JhZ2VcbiAgICogQHBhcmFtIGxvY2FsU3RvcmFnZU1hcHBlciBNYXBwZXIgZnVuY3Rpb24gZm9yIG1hcHBpbmcgc3RhdGUgdG8gbG9jYWwgc3RvcmVcbiAgICogQHBhcmFtIGxvY2FsU3RvcmFnZUFjdGlvbnMgQWN0aW9ucyBhZnRlciB3aGljaCB0byBzYXZlIHRvIGxvY2FsIHN0b3JhZ2VcbiAgICovXG4gIGluaXRMb2NhbFN0b3JlKGxvY2FsU3RvcmFnZU1hcHBlcjogKHN0YXRlOiBhbnkpID0+IGFueSA9IHMgPT4gcywgbG9jYWxTdG9yYWdlQWN0aW9ucyA9IFtdKTogYW55IHtcbiAgICB0aGlzLmxvY2FsU3RvcmFnZU1hcHBlciA9IGxvY2FsU3RvcmFnZU1hcHBlcjtcbiAgICB0aGlzLmxvY2FsU3RvcmFnZUFjdGlvbnMgPSBsb2NhbFN0b3JhZ2VBY3Rpb25zO1xuICAgIGNvbnN0IGxzID0gdGhpcy5sb2NhbFN0b3JlO1xuICAgIGNvbnN0IGxvY2FsU3RvcmUgPSBscyA/IEpTT04ucGFyc2UobHMpIDoge307XG4gICAgcmV0dXJuIGxvY2FsU3RvcmU7XG4gIH1cblxuICAvKipcbiAgICogSW5pdGlhbGl6ZSB0aGUgdXNlIG9mIHNlc3Npb24gc3RvcmFnZVxuICAgKiBAcGFyYW0gc2Vzc2lvblN0b3JhZ2VNYXBwZXIgTWFwcGVyIGZ1bmN0aW9uIGZvciBtYXBwaW5nIHN0YXRlIHRvIHNlc3Npb24gc3RvcmVcbiAgICogQHBhcmFtIHNlc3Npb25TdG9yYWdlQWN0aW9ucyBBY3Rpb25zIGFmdGVyIHdoaWNoIHRvIHNhdmUgdG8gc2Vzc2lvbiBzdG9yYWdlXG4gICAqL1xuICBpbml0U2Vzc2lvblN0b3JlKHNlc3Npb25TdG9yYWdlTWFwcGVyOiAoc3RhdGU6IGFueSkgPT4gYW55ID0gcyA9PiBzLCBzZXNzaW9uU3RvcmFnZUFjdGlvbnMgPSBbXSkge1xuICAgIHRoaXMuc2Vzc2lvblN0b3JhZ2VNYXBwZXIgPSBzZXNzaW9uU3RvcmFnZU1hcHBlcjtcbiAgICB0aGlzLnNlc3Npb25TdG9yYWdlQWN0aW9ucyA9IHNlc3Npb25TdG9yYWdlQWN0aW9ucztcbiAgICBjb25zdCBzcyA9IHRoaXMuc2Vzc2lvblN0b3JlO1xuICAgIGNvbnN0IHNlc3Npb25TdG9yZSA9IHNzID8gSlNPTi5wYXJzZShzcykgOiB7fTtcbiAgICByZXR1cm4gc2Vzc2lvblN0b3JhZ2U7XG4gIH1cblxuICBpbkxvY2FsU3RvcmFnZShhY3Rpb25UeXBlOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICByZXR1cm4gaW5BcnJheSh0aGlzLmxvY2FsU3RvcmFnZUFjdGlvbnMsIGFjdGlvblR5cGUpO1xuICB9XG5cbiAgaW5TZXNzaW9uU3RvcmFnZShhY3Rpb25UeXBlOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICByZXR1cm4gaW5BcnJheSh0aGlzLnNlc3Npb25TdG9yYWdlQWN0aW9ucywgYWN0aW9uVHlwZSk7XG4gIH1cblxuICAvKipcbiAgICogU3RvcmUgc3RhdGUgdG8gbG9jYWwgc3RvcmFnZS5cbiAgICovXG4gIHN0b3JlTG9jYWwoc3RhdGU6IGFueSwgYWN0aW9uOiBBY3Rpb24pIHtcbiAgICB0cnkge1xuICAgICAgLy8gY29uc3QgZmlsdGVyZWRTdGF0ZSA9IG5ldyBBY3Rpb25TdG9yZShhY3Rpb24sIHRoaXMuZmlsdGVyU3RhdGUoT2JqZWN0LmFzc2lnbih7fSwgc3RhdGUpKSk7XG4gICAgICBjb25zdCBmaWx0ZXJlZFN0YXRlID0gT2JqZWN0LmFzc2lnbihcbiAgICAgICAgZmlsdGVyU3RhdGUobmV3IEFjdGlvblN0b3JlKGFjdGlvbikpLFxuICAgICAgICBmaWx0ZXJTdGF0ZShPYmplY3QuYXNzaWduKHt9LFxuICAgICAgICAgIHRoaXMubG9jYWxTdG9yYWdlTWFwcGVyKHN0YXRlKSkpKTtcbiAgICAgIGNvbnN0IHNlcmlhbGl6ZWRTdGF0ZSA9IEpTT04uc3RyaW5naWZ5KGZpbHRlcmVkU3RhdGUpO1xuICAgICAgbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0odGhpcy5zdG9yZUtleSk7XG4gICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSh0aGlzLnN0b3JlS2V5LCBzZXJpYWxpemVkU3RhdGUpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgY29uc29sZS5lcnJvcihgRVJST1IgU0FWSU5HIExPQ0FMIFNUQVRFIVxcbkFjdGlvbjpcXHQke2FjdGlvbi5hY3Rpb25UeXBlfVxcbmAsIGVycik7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFN0b3JlIHN0YXRlIHRvIHNlc3Npb24gc3RvcmFnZS5cbiAgICovXG4gIHN0b3JlU2Vzc2lvbihzdGF0ZTogYW55LCBhY3Rpb246IEFjdGlvbikge1xuICAgIHRyeSB7XG4gICAgICAvLyBjb25zdCBmaWx0ZXJlZFN0YXRlID0gbmV3IEFjdGlvblN0b3JlKGFjdGlvbiwgdGhpcy5maWx0ZXJTdGF0ZShPYmplY3QuYXNzaWduKHt9LCBzdGF0ZSkpKTtcbiAgICAgIC8vIGNvbnN0IGZpbHRlcmVkU3RhdGUgPSB0aGlzLmZpbHRlclN0YXRlKE9iamVjdC5hc3NpZ24oe30sIHN0YXRlKSk7XG4gICAgICBjb25zdCBmaWx0ZXJlZFN0YXRlID0gT2JqZWN0LmFzc2lnbihcbiAgICAgICAgZmlsdGVyU3RhdGUobmV3IEFjdGlvblN0b3JlKGFjdGlvbikpLFxuICAgICAgICBmaWx0ZXJTdGF0ZShPYmplY3QuYXNzaWduKHt9LFxuICAgICAgICAgIHRoaXMuc2Vzc2lvblN0b3JhZ2VNYXBwZXIoc3RhdGUpKSkpO1xuICAgICAgY29uc3Qgc2VyaWFsaXplZFN0YXRlID0gSlNPTi5zdHJpbmdpZnkoZmlsdGVyZWRTdGF0ZSk7XG4gICAgICBsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbSh0aGlzLnN0b3JlS2V5KTtcbiAgICAgIHNlc3Npb25TdG9yYWdlLnNldEl0ZW0odGhpcy5zdG9yZUtleSwgc2VyaWFsaXplZFN0YXRlKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoYEVSUk9SIFNBVklORyBTRVNTSU9OIFNUQVRFIVxcbkFjdGlvbjpcXHQke2FjdGlvbi5hY3Rpb25UeXBlfVxcbmAsIGVycik7XG4gICAgfVxuICB9XG5cbn1cbiJdfQ==
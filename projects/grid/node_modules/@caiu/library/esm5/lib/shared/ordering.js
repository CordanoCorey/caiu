/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes} checked by tsc
 */
import * as tslib_1 from "tslib";
import { build } from './utils';
/**
 * @template T
 */
var /**
 * @template T
 */
Permutation = /** @class */ (function () {
    function Permutation(order) {
        this.order = order;
        this._timestamp = new Date();
    }
    Object.defineProperty(Permutation.prototype, "ranks", {
        get: /**
         * @return {?}
         */
        function () {
            return this.order.sort(function (a, b) { return a.order - b.order; })
                .map(function (x, index) { return Object.assign(/** @type {?} */ ({}), x, { rank: index + 1 }); });
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(Permutation.prototype, "timestamp", {
        get: /**
         * @return {?}
         */
        function () {
            return this._timestamp;
        },
        enumerable: true,
        configurable: true
    });
    return Permutation;
}());
/**
 * @template T
 */
export { Permutation };
function Permutation_tsickle_Closure_declarations() {
    /** @type {?} */
    Permutation.prototype._timestamp;
    /** @type {?} */
    Permutation.prototype.order;
}
/**
 * @template T
 */
var /**
 * @template T
 */
OrderedItem = /** @class */ (function () {
    function OrderedItem(item) {
        this.item = item;
    }
    return OrderedItem;
}());
/**
 * @template T
 */
export { OrderedItem };
function OrderedItem_tsickle_Closure_declarations() {
    /** @type {?} */
    OrderedItem.prototype.id;
    /** @type {?} */
    OrderedItem.prototype.order;
    /** @type {?} */
    OrderedItem.prototype.rank;
    /** @type {?} */
    OrderedItem.prototype.item;
}
/**
 * @template T
 */
var /**
 * @template T
 */
Ordering = /** @class */ (function () {
    function Ordering(_items, ctor, orderKey, idKey) {
        if (idKey === void 0) { idKey = 'id'; }
        this._items = _items;
        this.ctor = ctor;
        this.orderKey = orderKey;
        this.idKey = idKey;
        this._history = [];
    }
    Object.defineProperty(Ordering.prototype, "count", {
        get: /**
         * @return {?}
         */
        function () {
            return this.items.length;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(Ordering.prototype, "history", {
        get: /**
         * @return {?}
         */
        function () {
            return this._history;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(Ordering.prototype, "instance", {
        get: /**
         * @return {?}
         */
        function () {
            return new this.ctor();
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(Ordering.prototype, "items", {
        get: /**
         * @return {?}
         */
        function () {
            var _this = this;
            return this._items.sort(function (a, b) { return _this.getItemOrder(a) - _this.getItemOrder(b); });
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(Ordering.prototype, "maxIndex", {
        get: /**
         * @return {?}
         */
        function () {
            return this.count === 0 ? 0 : Math.max.apply(Math, tslib_1.__spread(this.order.map(function (x) { return x.order; })));
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(Ordering.prototype, "order", {
        get: /**
         * @return {?}
         */
        function () {
            return this.permutation.ranks;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(Ordering.prototype, "permutation", {
        get: /**
         * @return {?}
         */
        function () {
            var _this = this;
            return new Permutation(this.items.map(function (item) { return ({
                id: _this.getItemId(item),
                order: _this.getItemOrder(item)
            }); }));
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(Ordering.prototype, "nextPosition", {
        get: /**
         * @return {?}
         */
        function () {
            return this.maxIndex + 1;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * @param {?} item
     * @return {?}
     */
    Ordering.prototype.addItem = /**
     * @param {?} item
     * @return {?}
     */
    function (item) {
        return this.addItemAtPosition(item, this.nextPosition);
    };
    /**
     * @param {?} item
     * @param {?} pos
     * @return {?}
     */
    Ordering.prototype.addItemAtPosition = /**
     * @param {?} item
     * @param {?} pos
     * @return {?}
     */
    function (item, pos) {
        var _this = this;
        var /** @type {?} */ newItemId = this.getItemId(item);
        return tslib_1.__spread(this.items, [build(this.ctor, item, { order: pos })]).map(function (x) {
            var /** @type {?} */ order = _this.getItemOrder(x);
            var /** @type {?} */ id = _this.getItemId(x);
            return (order <= pos || id === newItemId) ? x : build(_this.ctor, x, { order: order + 1 });
        });
    };
    /**
     * @param {?=} items
     * @return {?}
     */
    Ordering.prototype.archive = /**
     * @param {?=} items
     * @return {?}
     */
    function (items) {
        var /** @type {?} */ permutation = items ? this.getPermutation(items) : this.permutation;
        this._history = tslib_1.__spread(this._history, [permutation]);
    };
    /**
     * @param {?} item
     * @return {?}
     */
    Ordering.prototype.getItemId = /**
     * @param {?} item
     * @return {?}
     */
    function (item) {
        return item[this.idKey];
    };
    /**
     * @param {?} item
     * @return {?}
     */
    Ordering.prototype.getItemOrder = /**
     * @param {?} item
     * @return {?}
     */
    function (item) {
        return item[this.orderKey];
    };
    /**
     * @param {?} items
     * @return {?}
     */
    Ordering.prototype.getPermutation = /**
     * @param {?} items
     * @return {?}
     */
    function (items) {
        var _this = this;
        return new Permutation(items.map(function (item) { return ({
            id: _this.getItemId(item),
            order: _this.getItemOrder(item)
        }); }));
    };
    /**
     * @param {?} item
     * @param {?} to
     * @return {?}
     */
    Ordering.prototype.move = /**
     * @param {?} item
     * @param {?} to
     * @return {?}
     */
    function (item, to) {
        var _this = this;
        var /** @type {?} */ from = this.getItemOrder(item);
        var /** @type {?} */ itemId = this.getItemId(item);
        if (to === from) {
            return tslib_1.__spread(this.items);
        }
        else if (to < from) {
            return this.items.map(function (x) {
                var /** @type {?} */ order = _this.getItemOrder(x);
                var /** @type {?} */ id = _this.getItemId(x);
                return id === itemId ? build(_this.ctor, x, { order: to })
                    : (order < to || order > from) ? x : build(_this.ctor, x, { order: order + 1 });
            });
        }
        else {
            // to > from
            return this.items.map(function (x) {
                var /** @type {?} */ order = _this.getItemOrder(x);
                var /** @type {?} */ id = _this.getItemId(x);
                return id === itemId ? build(_this.ctor, x, { order: to })
                    : (order < from || order > to) ? x : build(_this.ctor, x, { order: order - 1 });
            });
        }
    };
    /**
     * @param {?} item
     * @return {?}
     */
    Ordering.prototype.moveDown = /**
     * @param {?} item
     * @return {?}
     */
    function (item) {
        return this.move(item, this.getItemOrder(item) + 1);
    };
    /**
     * @param {?} item
     * @return {?}
     */
    Ordering.prototype.moveUp = /**
     * @param {?} item
     * @return {?}
     */
    function (item) {
        return this.move(item, this.getItemOrder(item) - 1);
    };
    /**
     * @param {?} item
     * @return {?}
     */
    Ordering.prototype.removeItem = /**
     * @param {?} item
     * @return {?}
     */
    function (item) {
        return this.removeItemAtPosition(this.getItemOrder(item));
    };
    /**
     * @param {?} pos
     * @return {?}
     */
    Ordering.prototype.removeItemAtPosition = /**
     * @param {?} pos
     * @return {?}
     */
    function (pos) {
        var _this = this;
        return this.items.filter(function (item) { return _this.getItemOrder(item) !== pos; })
            .map(function (x) {
            var /** @type {?} */ order = _this.getItemOrder(x);
            return order < pos ? x : build(_this.ctor, x, { order: order - 1 });
        });
    };
    /**
     * @param {?} items
     * @return {?}
     */
    Ordering.prototype.updateItems = /**
     * @param {?} items
     * @return {?}
     */
    function (items) {
        this.archive();
        this._items = items;
    };
    return Ordering;
}());
/**
 * @template T
 */
export { Ordering };
function Ordering_tsickle_Closure_declarations() {
    /** @type {?} */
    Ordering.prototype._history;
    /** @type {?} */
    Ordering.prototype._items;
    /** @type {?} */
    Ordering.prototype.ctor;
    /** @type {?} */
    Ordering.prototype.orderKey;
    /** @type {?} */
    Ordering.prototype.idKey;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib3JkZXJpbmcuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AY2FpdS9saWJyYXJ5LyIsInNvdXJjZXMiOlsibGliL3NoYXJlZC9vcmRlcmluZy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUNBLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxTQUFTLENBQUM7Ozs7QUFFaEM7OztBQUFBO0lBR0kscUJBQW1CLEtBQXVCO1FBQXZCLFVBQUssR0FBTCxLQUFLLENBQWtCO1FBQ3RDLElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxJQUFJLEVBQUUsQ0FBQztLQUNoQztJQUVELHNCQUFJLDhCQUFLOzs7O1FBQVQ7WUFDSSxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsVUFBQyxDQUFDLEVBQUUsQ0FBQyxJQUFLLE9BQUEsQ0FBQyxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUMsS0FBSyxFQUFqQixDQUFpQixDQUFDO2lCQUM5QyxHQUFHLENBQUMsVUFBQyxDQUFDLEVBQUUsS0FBSyxJQUFLLE9BQUEsTUFBTSxDQUFDLE1BQU0sbUJBQWlCLEVBQUUsR0FBRSxDQUFDLEVBQUUsRUFBRSxJQUFJLEVBQUUsS0FBSyxHQUFHLENBQUMsRUFBRSxDQUFDLEVBQXpELENBQXlELENBQUMsQ0FBQztTQUNyRjs7O09BQUE7SUFFRCxzQkFBSSxrQ0FBUzs7OztRQUFiO1lBQ0ksTUFBTSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUM7U0FDMUI7OztPQUFBO3NCQWpCTDtJQWtCQyxDQUFBOzs7O0FBZkQsdUJBZUM7Ozs7Ozs7Ozs7QUFFRDs7O0FBQUE7SUFLSSxxQkFBbUIsSUFBTztRQUFQLFNBQUksR0FBSixJQUFJLENBQUc7S0FDekI7c0JBMUJMO0lBMkJDLENBQUE7Ozs7QUFQRCx1QkFPQzs7Ozs7Ozs7Ozs7Ozs7QUFFRDs7O0FBQUE7SUFJSSxrQkFBb0IsTUFBVyxFQUFTLElBQXdCLEVBQVMsUUFBZ0IsRUFBUyxLQUFZOzRDQUFBO1FBQTFGLFdBQU0s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R0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxLQUFJLENBQUMsSUFBSSxFQUFFLENBQUMsRUFBRSxFQUFFLEtBQUssRUFBRSxLQUFLLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQztTQUN0RSxDQUFDLENBQUM7S0FDVjs7Ozs7SUFFRCw4QkFBVzs7OztJQUFYLFVBQVksS0FBVTtRQUNsQixJQUFJLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDZixJQUFJLENBQUMsTUFBTSxHQUFHLEtBQUssQ0FBQztLQUN2QjttQkF0Skw7SUF1SkMsQ0FBQTs7OztBQTFIRCxvQkEwSEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBUeXBlQ29uc3RydWN0b3IgfSBmcm9tICcuL21vZGVscyc7XHJcbmltcG9ydCB7IGJ1aWxkIH0gZnJvbSAnLi91dGlscyc7XHJcblxyXG5leHBvcnQgY2xhc3MgUGVybXV0YXRpb248VD4ge1xyXG4gICAgX3RpbWVzdGFtcDogRGF0ZTtcclxuXHJcbiAgICBjb25zdHJ1Y3RvcihwdWJsaWMgb3JkZXI6IE9yZGVyZWRJdGVtPFQ+W10pIHtcclxuICAgICAgICB0aGlzLl90aW1lc3RhbXAgPSBuZXcgRGF0ZSgpO1xyXG4gICAgfVxyXG5cclxuICAgIGdldCByYW5rcygpOiBPcmRlcmVkSXRlbTxUPltdIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5vcmRlci5zb3J0KChhLCBiKSA9PiBhLm9yZGVyIC0gYi5vcmRlcilcclxuICAgICAgICAgICAgLm1hcCgoeCwgaW5kZXgpID0+IE9iamVjdC5hc3NpZ24oPE9yZGVyZWRJdGVtPFQ+Pnt9LCB4LCB7IHJhbms6IGluZGV4ICsgMSB9KSk7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IHRpbWVzdGFtcCgpOiBEYXRlIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5fdGltZXN0YW1wO1xyXG4gICAgfVxyXG59XHJcblxyXG5leHBvcnQgY2xhc3MgT3JkZXJlZEl0ZW08VD4ge1xyXG4gICAgaWQ6IGFueTtcclxuICAgIG9yZGVyOiBudW1iZXI7XHJcbiAgICByYW5rPzogbnVtYmVyO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKHB1YmxpYyBpdGVtOiBUKSB7XHJcbiAgICB9XHJcbn1cclxuXHJcbmV4cG9ydCBjbGFzcyBPcmRlcmluZzxUPiB7XHJcblxyXG4gICAgcHJpdmF0ZSBfaGlzdG9yeTogUGVybXV0YXRpb248VD5bXSA9IFtdO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgX2l0ZW1zOiBUW10sIHB1YmxpYyBjdG9yOiBUeXBlQ29uc3RydWN0b3I8VD4sIHB1YmxpYyBvcmRlcktleTogc3RyaW5nLCBwdWJsaWMgaWRLZXkgPSAnaWQnKSB7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IGNvdW50KCk6IG51bWJlciB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuaXRlbXMubGVuZ3RoO1xyXG4gICAgfVxyXG5cclxuICAgIGdldCBoaXN0b3J5KCk6IFBlcm11dGF0aW9uPFQ+W10ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl9oaXN0b3J5O1xyXG4gICAgfVxyXG5cclxuICAgIGdldCBpbnN0YW5jZSgpOiBUIHtcclxuICAgICAgICByZXR1cm4gbmV3IHRoaXMuY3RvcigpO1xyXG4gICAgfVxyXG5cclxuICAgIGdldCBpdGVtcygpOiBUW10ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl9pdGVtcy5zb3J0KChhLCBiKSA9PiB0aGlzLmdldEl0ZW1PcmRlcihhKSAtIHRoaXMuZ2V0SXRlbU9yZGVyKGIpKTtcclxuICAgIH1cclxuXHJcbiAgICBnZXQgbWF4SW5kZXgoKTogbnVtYmVyIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5jb3VudCA9PT0gMCA/IDAgOiBNYXRoLm1heCguLi50aGlzLm9yZGVyLm1hcCh4ID0+IHgub3JkZXIpKTtcclxuICAgIH1cclxuXHJcbiAgICBnZXQgb3JkZXIoKTogT3JkZXJlZEl0ZW08VD5bXSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMucGVybXV0YXRpb24ucmFua3M7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IHBlcm11dGF0aW9uKCk6IFBlcm11dGF0aW9uPFQ+IHtcclxuICAgICAgICByZXR1cm4gbmV3IFBlcm11dGF0aW9uPFQ+KHRoaXMuaXRlbXMubWFwKGl0ZW0gPT4gPE9yZGVyZWRJdGVtPFQ+PntcclxuICAgICAgICAgICAgaWQ6IHRoaXMuZ2V0SXRlbUlkKGl0ZW0pLFxyXG4gICAgICAgICAgICBvcmRlcjogdGhpcy5nZXRJdGVtT3JkZXIoaXRlbSlcclxuICAgICAgICB9KSk7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IG5leHRQb3NpdGlvbigpOiBudW1iZXIge1xyXG4gICAgICAgIHJldHVybiB0aGlzLm1heEluZGV4ICsgMTtcclxuICAgIH1cclxuXHJcbiAgICBhZGRJdGVtKGl0ZW06IFQpOiBUW10ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmFkZEl0ZW1BdFBvc2l0aW9uKGl0ZW0sIHRoaXMubmV4dFBvc2l0aW9uKTtcclxuICAgIH1cclxuXHJcbiAgICBhZGRJdGVtQXRQb3NpdGlvbihpdGVtOiBULCBwb3M6IG51bWJlcik6IFRbXSB7XHJcbiAgICAgICAgY29uc3QgbmV3SXRlbUlkID0gdGhpcy5nZXRJdGVtSWQoaXRlbSk7XHJcbiAgICAgICAgcmV0dXJuIFsuLi50aGlzLml0ZW1zLCBidWlsZCh0aGlzLmN0b3IsIGl0ZW0sIHsgb3JkZXI6IHBvcyB9KV1cclxuICAgICAgICAgICAgLm1hcCh4ID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IG9yZGVyID0gdGhpcy5nZXRJdGVtT3JkZXIoeCk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBpZCA9IHRoaXMuZ2V0SXRlbUlkKHgpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIChvcmRlciA8PSBwb3MgfHwgaWQgPT09IG5ld0l0ZW1JZCkgPyB4IDogYnVpbGQodGhpcy5jdG9yLCB4LCB7IG9yZGVyOiBvcmRlciArIDEgfSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGFyY2hpdmUoaXRlbXM/OiBUW10pIHtcclxuICAgICAgICBjb25zdCBwZXJtdXRhdGlvbiA9IGl0ZW1zID8gdGhpcy5nZXRQZXJtdXRhdGlvbihpdGVtcykgOiB0aGlzLnBlcm11dGF0aW9uO1xyXG4gICAgICAgIHRoaXMuX2hpc3RvcnkgPSBbLi4udGhpcy5faGlzdG9yeSwgcGVybXV0YXRpb25dO1xyXG4gICAgfVxyXG5cclxuICAgIGdldEl0ZW1JZChpdGVtOiBUKTogYW55IHtcclxuICAgICAgICByZXR1cm4gaXRlbVt0aGlzLmlkS2V5XTtcclxuICAgIH1cclxuXHJcbiAgICBnZXRJdGVtT3JkZXIoaXRlbTogVCk6IG51bWJlciB7XHJcbiAgICAgICAgcmV0dXJuIGl0ZW1bdGhpcy5vcmRlcktleV07XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0UGVybXV0YXRpb24oaXRlbXM6IFRbXSk6IFBlcm11dGF0aW9uPFQ+IHtcclxuICAgICAgICByZXR1cm4gbmV3IFBlcm11dGF0aW9uKGl0ZW1zLm1hcChpdGVtID0+IDxPcmRlcmVkSXRlbTxUPj57XHJcbiAgICAgICAgICAgIGlkOiB0aGlzLmdldEl0ZW1JZChpdGVtKSxcclxuICAgICAgICAgICAgb3JkZXI6IHRoaXMuZ2V0SXRlbU9yZGVyKGl0ZW0pXHJcbiAgICAgICAgfSkpO1xyXG4gICAgfVxyXG5cclxuICAgIG1vdmUoaXRlbTogVCwgdG86IG51bWJlcik6IFRbXSB7XHJcbiAgICAgICAgY29uc3QgZnJvbSA9IHRoaXMuZ2V0SXRlbU9yZGVyKGl0ZW0pO1xyXG4gICAgICAgIGNvbnN0IGl0ZW1JZCA9IHRoaXMuZ2V0SXRlbUlkKGl0ZW0pO1xyXG4gICAgICAgIGlmICh0byA9PT0gZnJvbSkge1xyXG4gICAgICAgICAgICByZXR1cm4gWy4uLnRoaXMuaXRlbXNdO1xyXG4gICAgICAgIH0gZWxzZSBpZiAodG8gPCBmcm9tKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLml0ZW1zLm1hcCh4ID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IG9yZGVyID0gdGhpcy5nZXRJdGVtT3JkZXIoeCk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBpZCA9IHRoaXMuZ2V0SXRlbUlkKHgpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGlkID09PSBpdGVtSWQgPyBidWlsZCh0aGlzLmN0b3IsIHgsIHsgb3JkZXI6IHRvIH0pXHJcbiAgICAgICAgICAgICAgICAgICAgOiAob3JkZXIgPCB0byB8fCBvcmRlciA+IGZyb20pID8geCA6IGJ1aWxkKHRoaXMuY3RvciwgeCwgeyBvcmRlcjogb3JkZXIgKyAxIH0pO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9IGVsc2UgeyAvLyB0byA+IGZyb21cclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuaXRlbXMubWFwKHggPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uc3Qgb3JkZXIgPSB0aGlzLmdldEl0ZW1PcmRlcih4KTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGlkID0gdGhpcy5nZXRJdGVtSWQoeCk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gaWQgPT09IGl0ZW1JZCA/IGJ1aWxkKHRoaXMuY3RvciwgeCwgeyBvcmRlcjogdG8gfSlcclxuICAgICAgICAgICAgICAgICAgICA6IChvcmRlciA8IGZyb20gfHwgb3JkZXIgPiB0bykgPyB4IDogYnVpbGQodGhpcy5jdG9yLCB4LCB7IG9yZGVyOiBvcmRlciAtIDEgfSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBtb3ZlRG93bihpdGVtOiBUKTogVFtdIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5tb3ZlKGl0ZW0sIHRoaXMuZ2V0SXRlbU9yZGVyKGl0ZW0pICsgMSk7XHJcbiAgICB9XHJcblxyXG4gICAgbW92ZVVwKGl0ZW06IFQpOiBUW10ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLm1vdmUoaXRlbSwgdGhpcy5nZXRJdGVtT3JkZXIoaXRlbSkgLSAxKTtcclxuICAgIH1cclxuXHJcbiAgICByZW1vdmVJdGVtKGl0ZW06IFQpOiBUW10ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLnJlbW92ZUl0ZW1BdFBvc2l0aW9uKHRoaXMuZ2V0SXRlbU9yZGVyKGl0ZW0pKTtcclxuICAgIH1cclxuXHJcbiAgICByZW1vdmVJdGVtQXRQb3NpdGlvbihwb3M6IG51bWJlcik6IFRbXSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuaXRlbXMuZmlsdGVyKGl0ZW0gPT4gdGhpcy5nZXRJdGVtT3JkZXIoaXRlbSkgIT09IHBvcylcclxuICAgICAgICAgICAgLm1hcCh4ID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IG9yZGVyID0gdGhpcy5nZXRJdGVtT3JkZXIoeCk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gb3JkZXIgPCBwb3MgPyB4IDogYnVpbGQodGhpcy5jdG9yLCB4LCB7IG9yZGVyOiBvcmRlciAtIDEgfSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHVwZGF0ZUl0ZW1zKGl0ZW1zOiBUW10pOiB2b2lkIHtcclxuICAgICAgICB0aGlzLmFyY2hpdmUoKTtcclxuICAgICAgICB0aGlzLl9pdGVtcyA9IGl0ZW1zO1xyXG4gICAgfVxyXG59XHJcbiJdfQ==
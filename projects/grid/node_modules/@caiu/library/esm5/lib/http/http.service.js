/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes} checked by tsc
 */
import { Injectable } from '@angular/core';
import { HttpClient, HttpHeaders } from '@angular/common/http';
import { Observable, of, throwError } from 'rxjs';
import { catchError, debounceTime, distinctUntilChanged, finalize, map } from 'rxjs/operators';
import { HttpActions } from './http.actions';
import { HttpOptions } from './http.models';
import { QueryModel } from '../shared/models';
import { serialize } from '../shared/utils';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
import * as i2 from "rxjs/internal/Observable";
var HttpService = /** @class */ (function () {
    function HttpService(http, baseUrl$, authToken$) {
        var _this = this;
        this.http = http;
        this.baseUrl$ = baseUrl$;
        this.authToken$ = authToken$;
        this._authToken = '';
        this._baseUrl = '';
        this.headers = {};
        this.logEvents = true;
        this.useDefaultHeaders = true;
        this.authTokenChanges = this.authToken$.subscribe(function (x) {
            _this.authToken = x;
        });
        this.baseUrlChanges = this.baseUrl$.subscribe(function (x) {
            _this.baseUrl = x;
        });
    }
    Object.defineProperty(HttpService.prototype, "authToken", {
        get: /**
         * @return {?}
         */
        function () {
            return this._authToken;
        },
        set: /**
         * @param {?} value
         * @return {?}
         */
        function (value) {
            this._authToken = value;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(HttpService.prototype, "baseUrl", {
        get: /**
         * @return {?}
         */
        function () {
            return this._baseUrl;
        },
        set: /**
         * @param {?} value
         * @return {?}
         */
        function (value) {
            this._baseUrl = value;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(HttpService.prototype, "defaultHeaders", {
        get: /**
         * @return {?}
         */
        function () {
            var /** @type {?} */ headers = new HttpHeaders();
            headers = headers.append('Content-type', 'application/json');
            if (this.authToken) {
                headers = headers.append('Authorization', 'Bearer ' + this.authToken);
            }
            return headers;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(HttpService.prototype, "requestHeaders", {
        get: /**
         * @return {?}
         */
        function () {
            var _this = this;
            var /** @type {?} */ headers = this.useDefaultHeaders ? this.defaultHeaders : new HttpHeaders();
            Object.keys(this.headers).forEach(function (key) {
                headers = headers.append(key, _this.headers[key]);
            });
            return headers;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * @param {?=} headers
     * @return {?}
     */
    HttpService.prototype.appendHeaders = /**
     * @param {?=} headers
     * @return {?}
     */
    function (headers) {
        var _this = this;
        if (headers === void 0) { headers = {}; }
        var /** @type {?} */ requestHeaders = this.requestHeaders;
        Object.keys(headers).forEach(function (key) {
            requestHeaders = requestHeaders.append(key, _this.headers[key]);
        });
        return requestHeaders;
    };
    /**
     * Make a DELETE request.
     * @param relativePath
     * @param headers
     * @param options
     */
    /**
     * Make a DELETE request.
     * @param {?} relativePath
     * @param {?=} headers
     * @param {?=} options
     * @return {?}
     */
    HttpService.prototype.delete = /**
     * Make a DELETE request.
     * @param {?} relativePath
     * @param {?=} headers
     * @param {?=} options
     * @return {?}
     */
    function (relativePath, headers, options) {
        var _this = this;
        if (headers === void 0) { headers = {}; }
        if (options === void 0) { options = new HttpOptions(); }
        var /** @type {?} */ url = options.prependBaseUrl ? this.formatUrl(relativePath) : relativePath;
        var /** @type {?} */ httpHeaders = this.appendHeaders(headers);
        var /** @type {?} */ obs = this.http.delete(url, {
            headers: httpHeaders
        });
        return obs.pipe(map(function (res) { return res && res['json'] && typeof res['json'] === 'function' ? res['json']() : res; }), catchError(function (err) { return _this.onError(err); }), finalize(function () {
            _this.onComplete('DELETE', url);
        }));
    };
    /**
     * Make a GET request.
     * @param relativePath
     * @param headers
     * @param options
     */
    /**
     * Make a GET request.
     * @param {?} relativePath
     * @param {?=} headers
     * @param {?=} options
     * @return {?}
     */
    HttpService.prototype.get = /**
     * Make a GET request.
     * @param {?} relativePath
     * @param {?=} headers
     * @param {?=} options
     * @return {?}
     */
    function (relativePath, headers, options) {
        var _this = this;
        if (headers === void 0) { headers = {}; }
        if (options === void 0) { options = new HttpOptions(); }
        var /** @type {?} */ url = options.prependBaseUrl ? this.formatUrl(relativePath) : relativePath;
        var /** @type {?} */ httpHeaders = this.appendHeaders(headers);
        var /** @type {?} */ obs = this.http.get(url, {
            headers: httpHeaders
        });
        return obs.pipe(map(function (res) { return res && res['json'] && typeof res['json'] === 'function' ? res['json']() : res; }), catchError(function (err) { return _this.onError(err); }), finalize(function () {
            _this.onComplete('GET', url);
        }));
    };
    ;
    /**
     * Make an autocomplete GET request.
     * @param relativePath
     * @param headers
     * @param options
     */
    /**
     * Make an autocomplete GET request.
     * @param {?} relativePath
     * @param {?} query
     * @param {?=} headers
     * @param {?=} options
     * @return {?}
     */
    HttpService.prototype.autocomplete = /**
     * Make an autocomplete GET request.
     * @param {?} relativePath
     * @param {?} query
     * @param {?=} headers
     * @param {?=} options
     * @return {?}
     */
    function (relativePath, query, headers, options) {
        var _this = this;
        if (headers === void 0) { headers = {}; }
        if (options === void 0) { options = new HttpOptions(); }
        if (!query.term || query.term.length < 1) {
            return of([]);
        }
        var /** @type {?} */ path = relativePath + "/" + QueryModel.BuildQueryString(query);
        var /** @type {?} */ url = options.prependBaseUrl ? this.formatUrl(relativePath) : relativePath;
        var /** @type {?} */ httpHeaders = this.appendHeaders(headers);
        var /** @type {?} */ obs = this.http.get(url, {
            headers: httpHeaders
        });
        return obs.pipe(map(function (res) { return res && res['json'] && typeof res['json'] === 'function' ? res['json']() : res; }), debounceTime(500), distinctUntilChanged(), map(function (json) { return HttpActions.matchPath(path, json); }), catchError(function (err) { return _this.onError(err); }), finalize(function () {
            _this.onComplete('GET', url);
        }));
    };
    ;
    /**
     * Make a POST request.
     * @param relativePath
     * @param body
     * @param headers
     * @param options
     */
    /**
     * Make a POST request.
     * @param {?} relativePath
     * @param {?} body
     * @param {?=} headers
     * @param {?=} options
     * @return {?}
     */
    HttpService.prototype.post = /**
     * Make a POST request.
     * @param {?} relativePath
     * @param {?} body
     * @param {?=} headers
     * @param {?=} options
     * @return {?}
     */
    function (relativePath, body, headers, options) {
        var _this = this;
        if (headers === void 0) { headers = {}; }
        if (options === void 0) { options = new HttpOptions(); }
        var /** @type {?} */ url = options.prependBaseUrl ? this.formatUrl(relativePath) : relativePath;
        var /** @type {?} */ httpHeaders = this.appendHeaders(headers);
        var /** @type {?} */ obs = this.http.post(url, serialize(body), {
            headers: httpHeaders
        });
        return obs.pipe(map(function (res) { return res && res['json'] && typeof res['json'] === 'function' ? res['json']() : res; }), catchError(function (err) { return _this.onError(err); }), finalize(function () {
            _this.onComplete('POST', url);
        }));
    };
    /**
     * Make a POST request with form url-encoded content type.
     * @param relativePath
     * @param body
     * @param headers
     * @param options
     */
    /**
     * Make a POST request with form url-encoded content type.
     * @param {?} relativePath
     * @param {?} body
     * @param {?=} headers
     * @param {?=} options
     * @return {?}
     */
    HttpService.prototype.postFormUrlEncoded = /**
     * Make a POST request with form url-encoded content type.
     * @param {?} relativePath
     * @param {?} body
     * @param {?=} headers
     * @param {?=} options
     * @return {?}
     */
    function (relativePath, body, headers, options) {
        var _this = this;
        if (headers === void 0) { headers = {}; }
        if (options === void 0) { options = new HttpOptions(); }
        var /** @type {?} */ url = options.prependBaseUrl ? this.formatUrl(relativePath) : relativePath;
        var /** @type {?} */ httpHeaders = new HttpHeaders({ 'content-type': 'application/x-www-form-urlencoded' });
        var /** @type {?} */ obs = this.http.post(url, body, {
            headers: httpHeaders
        });
        return obs.pipe(map(function (res) { return res && res['json'] && typeof res['json'] === 'function' ? res['json']() : res; }), catchError(function (err) { return _this.onError(err); }), finalize(function () {
            _this.onComplete('POST FORM URL-ENCODED', url);
        }));
    };
    /**
     * Make a PUT request.
     * @param relativePath
     * @param body
     * @param headers
     * @param options
     */
    /**
     * Make a PUT request.
     * @param {?} relativePath
     * @param {?} body
     * @param {?=} headers
     * @param {?=} options
     * @return {?}
     */
    HttpService.prototype.put = /**
     * Make a PUT request.
     * @param {?} relativePath
     * @param {?} body
     * @param {?=} headers
     * @param {?=} options
     * @return {?}
     */
    function (relativePath, body, headers, options) {
        var _this = this;
        if (headers === void 0) { headers = {}; }
        if (options === void 0) { options = new HttpOptions(); }
        var /** @type {?} */ url = options.prependBaseUrl ? this.formatUrl(relativePath) : relativePath;
        var /** @type {?} */ httpHeaders = this.appendHeaders(headers);
        var /** @type {?} */ obs = this.http.put(url, serialize(body), {
            headers: httpHeaders
        });
        return obs.pipe(map(function (res) { return res && res['json'] && typeof res['json'] === 'function' ? res['json']() : res; }), catchError(function (err) { return _this.onError(err); }), finalize(function () {
            _this.onComplete('PUT', url);
        }));
    };
    /**
     * This method will be used to format URLs for all cross-origin requests.
     */
    /**
     * This method will be used to format URLs for all cross-origin requests.
     * @param {?} path
     * @return {?}
     */
    HttpService.prototype.formatUrl = /**
     * This method will be used to format URLs for all cross-origin requests.
     * @param {?} path
     * @return {?}
     */
    function (path) {
        return this.baseUrl + "/" + path;
    };
    /**
     * Use this method when a promise is preferred over an observable.
     */
    /**
     * Use this method when a promise is preferred over an observable.
     * @param {?} url
     * @return {?}
     */
    HttpService.prototype.getPromise = /**
     * Use this method when a promise is preferred over an observable.
     * @param {?} url
     * @return {?}
     */
    function (url) {
        return this.get(url)
            .toPromise()
            .then(function (res) { return res.json(); });
    };
    /**
     * @param {?} error
     * @return {?}
     */
    HttpService.prototype.onError = /**
     * @param {?} error
     * @return {?}
     */
    function (error) {
        var /** @type {?} */ errorBody;
        try {
            errorBody = (error._body) ? JSON.parse(error._body) : { message: 'Internal server error', statusCode: error.status };
        }
        catch (/** @type {?} */ e) {
            if (error.status <= 0) {
                errorBody = { message: 'Internal server error.', statusCode: 500 };
            }
        }
        if (errorBody.message) {
            errorBody.message = errorBody.message.replace('An error has occured in the api.System.Exception: ', '');
            errorBody.message = errorBody.message.substring(0, errorBody.message.indexOf(' at'));
        }
        return throwError(errorBody);
    };
    /**
     * @param {?} method
     * @param {?} url
     * @return {?}
     */
    HttpService.prototype.onComplete = /**
     * @param {?} method
     * @param {?} url
     * @return {?}
     */
    function (method, url) {
        if (this.logEvents) {
            console.log("Completed " + method + " request to " + url);
        }
    };
    HttpService.decorators = [
        { type: Injectable, args: [{
                    providedIn: 'root'
                },] },
    ];
    /** @nocollapse */
    HttpService.ctorParameters = function () { return [
        { type: HttpClient },
        { type: Observable },
        { type: Observable }
    ]; };
    /** @nocollapse */ HttpService.ngInjectableDef = i0.defineInjectable({ factory: function HttpService_Factory() { return new HttpService(i0.inject(i1.HttpClient), i0.inject(i2.Observable), i0.inject(i2.Observable)); }, token: HttpService, providedIn: "root" });
    return HttpService;
}());
export { HttpService };
function HttpService_tsickle_Closure_declarations() {
    /** @type {?} */
    HttpService.prototype._authToken;
    /** @type {?} */
    HttpService.prototype._baseUrl;
    /** @type {?} */
    HttpService.prototype.authTokenChanges;
    /** @type {?} */
    HttpService.prototype.baseUrlChanges;
    /** @type {?} */
    HttpService.prototype.headers;
    /** @type {?} */
    HttpService.prototype.logEvents;
    /** @type {?} */
    HttpService.prototype.useDefaultHeaders;
    /** @type {?} */
    HttpService.prototype.http;
    /** @type {?} */
    HttpService.prototype.baseUrl$;
    /** @type {?} */
    HttpService.prototype.authToken$;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaHR0cC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGNhaXUvbGlicmFyeS8iLCJzb3VyY2VzIjpbImxpYi9odHRwL2h0dHAuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsVUFBVSxFQUFFLFdBQVcsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQy9ELE9BQU8sRUFBRSxVQUFVLEVBQWdCLEVBQUUsRUFBRSxVQUFVLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDaEUsT0FBTyxFQUNILFVBQVUsRUFDVixZQUFZLEVBQ1osb0JBQW9CLEVBQ3BCLFFBQVEsRUFDUixHQUFHLEVBQ04sTUFBTSxnQkFBZ0IsQ0FBQztBQUV4QixPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDN0MsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUM1QyxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDOUMsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGlCQUFpQixDQUFDOzs7OztJQWV4QyxxQkFDVyxNQUNDLFVBQ0E7UUFIWixpQkFXQztRQVZVLFNBQUksR0FBSixJQUFJO1FBQ0gsYUFBUSxHQUFSLFFBQVE7UUFDUixlQUFVLEdBQVYsVUFBVTswQkFYRCxFQUFFO3dCQUNKLEVBQUU7dUJBR1gsRUFBRTt5QkFDQSxJQUFJO2lDQUNJLElBQUk7UUFPcEIsSUFBSSxDQUFDLGdCQUFnQixHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsU0FBUyxDQUFDLFVBQUEsQ0FBQztZQUMvQyxLQUFJLENBQUMsU0FBUyxHQUFHLENBQUMsQ0FBQztTQUN0QixDQUFDLENBQUM7UUFDSCxJQUFJLENBQUMsY0FBYyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLFVBQUEsQ0FBQztZQUMzQyxLQUFJLENB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VUFBVSxFQUFFLEdBQUcsRUFBRSxDQUFDO2FBQ3RFO1NBQ0o7UUFDRCxFQUFFLENBQUMsQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztZQUNwQixTQUFTLENBQUMsT0FBTyxHQUFHLFNBQVMsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLG9EQUFvRCxFQUFFLEVBQUUsQ0FBQyxDQUFDO1lBQ3hHLFNBQVMsQ0FBQyxPQUFPLEdBQUcsU0FBUyxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQyxFQUFFLFNBQVMsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7U0FDeEY7UUFDRCxNQUFNLENBQUMsVUFBVSxDQUFDLFNBQVMsQ0FBQyxDQUFDOzs7Ozs7O0lBR3pCLGdDQUFVOzs7OztjQUFDLE1BQWMsRUFBRSxHQUFXO1FBQzFDLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDO1lBQ2pCLE9BQU8sQ0FBQyxHQUFHLENBQUMsZUFBYSxNQUFNLG9CQUFlLEdBQUssQ0FBQyxDQUFDO1NBQ3hEOzs7Z0JBOU9SLFVBQVUsU0FBQztvQkFDUixVQUFVLEVBQUUsTUFBTTtpQkFDckI7Ozs7Z0JBakJRLFVBQVU7Z0JBQ1YsVUFBVTtnQkFBVixVQUFVOzs7c0JBRm5COztTQW1CYSxXQUFXIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgSHR0cENsaWVudCwgSHR0cEhlYWRlcnMgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBTdWJzY3JpcHRpb24sIG9mLCB0aHJvd0Vycm9yIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQge1xuICAgIGNhdGNoRXJyb3IsXG4gICAgZGVib3VuY2VUaW1lLFxuICAgIGRpc3RpbmN0VW50aWxDaGFuZ2VkLFxuICAgIGZpbmFsaXplLFxuICAgIG1hcFxufSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbmltcG9ydCB7IEh0dHBBY3Rpb25zIH0gZnJvbSAnLi9odHRwLmFjdGlvbnMnO1xuaW1wb3J0IHsgSHR0cE9wdGlvbnMgfSBmcm9tICcuL2h0dHAubW9kZWxzJztcbmltcG9ydCB7IFF1ZXJ5TW9kZWwgfSBmcm9tICcuLi9zaGFyZWQvbW9kZWxzJztcbmltcG9ydCB7IHNlcmlhbGl6ZSB9IGZyb20gJy4uL3NoYXJlZC91dGlscyc7XG5cbkBJbmplY3RhYmxlKHtcbiAgICBwcm92aWRlZEluOiAncm9vdCdcbn0pXG5leHBvcnQgY2xhc3MgSHR0cFNlcnZpY2Uge1xuXG4gICAgcHJpdmF0ZSBfYXV0aFRva2VuID0gJyc7XG4gICAgcHJpdmF0ZSBfYmFzZVVybCA9ICcnO1xuICAgIHByaXZhdGUgYXV0aFRva2VuQ2hhbmdlczogU3Vic2NyaXB0aW9uO1xuICAgIHByaXZhdGUgYmFzZVVybENoYW5nZXM6IFN1YnNjcmlwdGlvbjtcbiAgICBoZWFkZXJzID0ge307XG4gICAgbG9nRXZlbnRzID0gdHJ1ZTtcbiAgICB1c2VEZWZhdWx0SGVhZGVycyA9IHRydWU7XG5cbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgcHVibGljIGh0dHA6IEh0dHBDbGllbnQsXG4gICAgICAgIHByaXZhdGUgYmFzZVVybCQ6IE9ic2VydmFibGU8c3RyaW5nPixcbiAgICAgICAgcHJpdmF0ZSBhdXRoVG9rZW4kOiBPYnNlcnZhYmxlPHN0cmluZz5cbiAgICApIHtcbiAgICAgICAgdGhpcy5hdXRoVG9rZW5DaGFuZ2VzID0gdGhpcy5hdXRoVG9rZW4kLnN1YnNjcmliZSh4ID0+IHtcbiAgICAgICAgICAgIHRoaXMuYXV0aFRva2VuID0geDtcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMuYmFzZVVybENoYW5nZXMgPSB0aGlzLmJhc2VVcmwkLnN1YnNjcmliZSh4ID0+IHtcbiAgICAgICAgICAgIHRoaXMuYmFzZVVybCA9IHg7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGdldCBhdXRoVG9rZW4oKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2F1dGhUb2tlbjtcbiAgICB9XG5cbiAgICBzZXQgYXV0aFRva2VuKHZhbHVlOiBzdHJpbmcpIHtcbiAgICAgICAgdGhpcy5fYXV0aFRva2VuID0gdmFsdWU7XG4gICAgfVxuXG4gICAgZ2V0IGJhc2VVcmwoKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2Jhc2VVcmw7XG4gICAgfVxuXG4gICAgc2V0IGJhc2VVcmwodmFsdWU6IHN0cmluZykge1xuICAgICAgICB0aGlzLl9iYXNlVXJsID0gdmFsdWU7XG4gICAgfVxuXG4gICAgZ2V0IGRlZmF1bHRIZWFkZXJzKCk6IEh0dHBIZWFkZXJzIHtcbiAgICAgICAgbGV0IGhlYWRlcnM6IEh0dHBIZWFkZXJzID0gbmV3IEh0dHBIZWFkZXJzKCk7XG4gICAgICAgIGhlYWRlcnMgPSBoZWFkZXJzLmFwcGVuZCgnQ29udGVudC10eXBlJywgJ2FwcGxpY2F0aW9uL2pzb24nKTtcbiAgICAgICAgaWYgKHRoaXMuYXV0aFRva2VuKSB7XG4gICAgICAgICAgICBoZWFkZXJzID0gaGVhZGVycy5hcHBlbmQoJ0F1dGhvcml6YXRpb24nLCAnQmVhcmVyICcgKyB0aGlzLmF1dGhUb2tlbik7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGhlYWRlcnM7XG4gICAgfVxuXG4gICAgZ2V0IHJlcXVlc3RIZWFkZXJzKCk6IEh0dHBIZWFkZXJzIHtcbiAgICAgICAgbGV0IGhlYWRlcnM6IEh0dHBIZWFkZXJzID0gdGhpcy51c2VEZWZhdWx0SGVhZGVycyA/IHRoaXMuZGVmYXVsdEhlYWRlcnMgOiBuZXcgSHR0cEhlYWRlcnMoKTtcbiAgICAgICAgT2JqZWN0LmtleXModGhpcy5oZWFkZXJzKS5mb3JFYWNoKGtleSA9PiB7XG4gICAgICAgICAgICBoZWFkZXJzID0gaGVhZGVycy5hcHBlbmQoa2V5LCB0aGlzLmhlYWRlcnNba2V5XSk7XG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gaGVhZGVycztcbiAgICB9XG5cbiAgICBhcHBlbmRIZWFkZXJzKGhlYWRlcnMgPSB7fSk6IEh0dHBIZWFkZXJzIHtcbiAgICAgICAgbGV0IHJlcXVlc3RIZWFkZXJzID0gdGhpcy5yZXF1ZXN0SGVhZGVycztcbiAgICAgICAgT2JqZWN0LmtleXMoaGVhZGVycykuZm9yRWFjaChrZXkgPT4ge1xuICAgICAgICAgICAgcmVxdWVzdEhlYWRlcnMgPSByZXF1ZXN0SGVhZGVycy5hcHBlbmQoa2V5LCB0aGlzLmhlYWRlcnNba2V5XSk7XG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gcmVxdWVzdEhlYWRlcnM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogTWFrZSBhIERFTEVURSByZXF1ZXN0LlxuICAgICAqIEBwYXJhbSByZWxhdGl2ZVBhdGggXG4gICAgICogQHBhcmFtIGhlYWRlcnMgXG4gICAgICogQHBhcmFtIG9wdGlvbnMgXG4gICAgICovXG4gICAgZGVsZXRlKHJlbGF0aXZlUGF0aDogc3RyaW5nLCBoZWFkZXJzID0ge30sIG9wdGlvbnM6IEh0dHBPcHRpb25zID0gbmV3IEh0dHBPcHRpb25zKCkpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgICAgICBjb25zdCB1cmwgPSBvcHRpb25zLnByZXBlbmRCYXNlVXJsID8gdGhpcy5mb3JtYXRVcmwocmVsYXRpdmVQYXRoKSA6IHJlbGF0aXZlUGF0aDtcbiAgICAgICAgY29uc3QgaHR0cEhlYWRlcnMgPSB0aGlzLmFwcGVuZEhlYWRlcnMoaGVhZGVycyk7XG4gICAgICAgIGNvbnN0IG9icyA9IHRoaXMuaHR0cC5kZWxldGUodXJsLCB7XG4gICAgICAgICAgICBoZWFkZXJzOiBodHRwSGVhZGVyc1xuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIG9icy5waXBlKFxuICAgICAgICAgICAgbWFwKHJlcyA9PiByZXMgJiYgcmVzWydqc29uJ10gJiYgdHlwZW9mIHJlc1snanNvbiddID09PSAnZnVuY3Rpb24nID8gcmVzWydqc29uJ10oKSA6IHJlcyksXG4gICAgICAgICAgICBjYXRjaEVycm9yKGVyciA9PiB0aGlzLm9uRXJyb3IoZXJyKSksXG4gICAgICAgICAgICBmaW5hbGl6ZSgoKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5vbkNvbXBsZXRlKCdERUxFVEUnLCB1cmwpO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBNYWtlIGEgR0VUIHJlcXVlc3QuXG4gICAgICogQHBhcmFtIHJlbGF0aXZlUGF0aCBcbiAgICAgKiBAcGFyYW0gaGVhZGVycyBcbiAgICAgKiBAcGFyYW0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBnZXQocmVsYXRpdmVQYXRoOiBzdHJpbmcsIGhlYWRlcnMgPSB7fSwgb3B0aW9uczogSHR0cE9wdGlvbnMgPSBuZXcgSHR0cE9wdGlvbnMoKSk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgICAgIGNvbnN0IHVybCA9IG9wdGlvbnMucHJlcGVuZEJhc2VVcmwgPyB0aGlzLmZvcm1hdFVybChyZWxhdGl2ZVBhdGgpIDogcmVsYXRpdmVQYXRoO1xuICAgICAgICBjb25zdCBodHRwSGVhZGVycyA9IHRoaXMuYXBwZW5kSGVhZGVycyhoZWFkZXJzKTtcbiAgICAgICAgY29uc3Qgb2JzID0gdGhpcy5odHRwLmdldCh1cmwsIHtcbiAgICAgICAgICAgIGhlYWRlcnM6IGh0dHBIZWFkZXJzXG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gb2JzLnBpcGUoXG4gICAgICAgICAgICBtYXAocmVzID0+IHJlcyAmJiByZXNbJ2pzb24nXSAmJiB0eXBlb2YgcmVzWydqc29uJ10gPT09ICdmdW5jdGlvbicgPyByZXNbJ2pzb24nXSgpIDogcmVzKSxcbiAgICAgICAgICAgIGNhdGNoRXJyb3IoZXJyID0+IHRoaXMub25FcnJvcihlcnIpKSxcbiAgICAgICAgICAgIGZpbmFsaXplKCgpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLm9uQ29tcGxldGUoJ0dFVCcsIHVybCk7XG4gICAgICAgICAgICB9KVxuICAgICAgICApO1xuICAgIH07XG5cbiAgICAvKipcbiAgICAgKiBNYWtlIGFuIGF1dG9jb21wbGV0ZSBHRVQgcmVxdWVzdC5cbiAgICAgKiBAcGFyYW0gcmVsYXRpdmVQYXRoIFxuICAgICAqIEBwYXJhbSBoZWFkZXJzIFxuICAgICAqIEBwYXJhbSBvcHRpb25zIFxuICAgICAqL1xuICAgIGF1dG9jb21wbGV0ZShyZWxhdGl2ZVBhdGg6IHN0cmluZywgcXVlcnk6IFF1ZXJ5TW9kZWw8YW55PiwgaGVhZGVycyA9IHt9LCBvcHRpb25zOiBIdHRwT3B0aW9ucyA9IG5ldyBIdHRwT3B0aW9ucygpKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICAgICAgaWYgKCFxdWVyeS50ZXJtIHx8IHF1ZXJ5LnRlcm0ubGVuZ3RoIDwgMSkge1xuICAgICAgICAgICAgcmV0dXJuIG9mKFtdKTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBwYXRoID0gYCR7cmVsYXRpdmVQYXRofS8ke1F1ZXJ5TW9kZWwuQnVpbGRRdWVyeVN0cmluZyhxdWVyeSl9YDtcbiAgICAgICAgY29uc3QgdXJsID0gb3B0aW9ucy5wcmVwZW5kQmFzZVVybCA/IHRoaXMuZm9ybWF0VXJsKHJlbGF0aXZlUGF0aCkgOiByZWxhdGl2ZVBhdGg7XG4gICAgICAgIGNvbnN0IGh0dHBIZWFkZXJzID0gdGhpcy5hcHBlbmRIZWFkZXJzKGhlYWRlcnMpO1xuICAgICAgICBjb25zdCBvYnMgPSB0aGlzLmh0dHAuZ2V0KHVybCwge1xuICAgICAgICAgICAgaGVhZGVyczogaHR0cEhlYWRlcnNcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBvYnMucGlwZShcbiAgICAgICAgICAgIG1hcChyZXMgPT4gcmVzICYmIHJlc1snanNvbiddICYmIHR5cGVvZiByZXNbJ2pzb24nXSA9PT0gJ2Z1bmN0aW9uJyA/IHJlc1snanNvbiddKCkgOiByZXMpLFxuICAgICAgICAgICAgZGVib3VuY2VUaW1lKDUwMCksXG4gICAgICAgICAgICBkaXN0aW5jdFVudGlsQ2hhbmdlZCgpLFxuICAgICAgICAgICAgbWFwKGpzb24gPT4gSHR0cEFjdGlvbnMubWF0Y2hQYXRoKHBhdGgsIGpzb24pKSxcbiAgICAgICAgICAgIGNhdGNoRXJyb3IoZXJyID0+IHRoaXMub25FcnJvcihlcnIpKSxcbiAgICAgICAgICAgIGZpbmFsaXplKCgpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLm9uQ29tcGxldGUoJ0dFVCcsIHVybCk7XG4gICAgICAgICAgICB9KVxuICAgICAgICApO1xuICAgIH07XG5cbiAgICAvKipcbiAgICAgKiBNYWtlIGEgUE9TVCByZXF1ZXN0LlxuICAgICAqIEBwYXJhbSByZWxhdGl2ZVBhdGggXG4gICAgICogQHBhcmFtIGJvZHkgXG4gICAgICogQHBhcmFtIGhlYWRlcnMgXG4gICAgICogQHBhcmFtIG9wdGlvbnMgXG4gICAgICovXG4gICAgcG9zdChyZWxhdGl2ZVBhdGg6IHN0cmluZywgYm9keTogYW55LCBoZWFkZXJzID0ge30sIG9wdGlvbnM6IEh0dHBPcHRpb25zID0gbmV3IEh0dHBPcHRpb25zKCkpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgICAgICBjb25zdCB1cmwgPSBvcHRpb25zLnByZXBlbmRCYXNlVXJsID8gdGhpcy5mb3JtYXRVcmwocmVsYXRpdmVQYXRoKSA6IHJlbGF0aXZlUGF0aDtcbiAgICAgICAgY29uc3QgaHR0cEhlYWRlcnMgPSB0aGlzLmFwcGVuZEhlYWRlcnMoaGVhZGVycyk7XG4gICAgICAgIGNvbnN0IG9icyA9IHRoaXMuaHR0cC5wb3N0KHVybCwgc2VyaWFsaXplKGJvZHkpLCB7XG4gICAgICAgICAgICBoZWFkZXJzOiBodHRwSGVhZGVyc1xuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIG9icy5waXBlKFxuICAgICAgICAgICAgbWFwKHJlcyA9PiByZXMgJiYgcmVzWydqc29uJ10gJiYgdHlwZW9mIHJlc1snanNvbiddID09PSAnZnVuY3Rpb24nID8gcmVzWydqc29uJ10oKSA6IHJlcyksXG4gICAgICAgICAgICBjYXRjaEVycm9yKGVyciA9PiB0aGlzLm9uRXJyb3IoZXJyKSksXG4gICAgICAgICAgICBmaW5hbGl6ZSgoKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5vbkNvbXBsZXRlKCdQT1NUJywgdXJsKTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogTWFrZSBhIFBPU1QgcmVxdWVzdCB3aXRoIGZvcm0gdXJsLWVuY29kZWQgY29udGVudCB0eXBlLlxuICAgICAqIEBwYXJhbSByZWxhdGl2ZVBhdGggXG4gICAgICogQHBhcmFtIGJvZHkgXG4gICAgICogQHBhcmFtIGhlYWRlcnMgXG4gICAgICogQHBhcmFtIG9wdGlvbnMgXG4gICAgICovXG4gICAgcG9zdEZvcm1VcmxFbmNvZGVkKHJlbGF0aXZlUGF0aDogc3RyaW5nLCBib2R5OiBhbnksIGhlYWRlcnMgPSB7fSwgb3B0aW9uczogSHR0cE9wdGlvbnMgPSBuZXcgSHR0cE9wdGlvbnMoKSk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgICAgIGNvbnN0IHVybCA9IG9wdGlvbnMucHJlcGVuZEJhc2VVcmwgPyB0aGlzLmZvcm1hdFVybChyZWxhdGl2ZVBhdGgpIDogcmVsYXRpdmVQYXRoO1xuICAgICAgICBjb25zdCBodHRwSGVhZGVycyA9IG5ldyBIdHRwSGVhZGVycyh7ICdjb250ZW50LXR5cGUnOiAnYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkJyB9KTtcbiAgICAgICAgY29uc3Qgb2JzID0gdGhpcy5odHRwLnBvc3QodXJsLCBib2R5LCB7XG4gICAgICAgICAgICBoZWFkZXJzOiBodHRwSGVhZGVyc1xuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIG9icy5waXBlKFxuICAgICAgICAgICAgbWFwKHJlcyA9PiByZXMgJiYgcmVzWydqc29uJ10gJiYgdHlwZW9mIHJlc1snanNvbiddID09PSAnZnVuY3Rpb24nID8gcmVzWydqc29uJ10oKSA6IHJlcyksXG4gICAgICAgICAgICBjYXRjaEVycm9yKGVyciA9PiB0aGlzLm9uRXJyb3IoZXJyKSksXG4gICAgICAgICAgICBmaW5hbGl6ZSgoKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5vbkNvbXBsZXRlKCdQT1NUIEZPUk0gVVJMLUVOQ09ERUQnLCB1cmwpO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBNYWtlIGEgUFVUIHJlcXVlc3QuXG4gICAgICogQHBhcmFtIHJlbGF0aXZlUGF0aCBcbiAgICAgKiBAcGFyYW0gYm9keSBcbiAgICAgKiBAcGFyYW0gaGVhZGVycyBcbiAgICAgKiBAcGFyYW0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBwdXQocmVsYXRpdmVQYXRoOiBzdHJpbmcsIGJvZHk6IGFueSwgaGVhZGVycyA9IHt9LCBvcHRpb25zOiBIdHRwT3B0aW9ucyA9IG5ldyBIdHRwT3B0aW9ucygpKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICAgICAgY29uc3QgdXJsID0gb3B0aW9ucy5wcmVwZW5kQmFzZVVybCA/IHRoaXMuZm9ybWF0VXJsKHJlbGF0aXZlUGF0aCkgOiByZWxhdGl2ZVBhdGg7XG4gICAgICAgIGNvbnN0IGh0dHBIZWFkZXJzID0gdGhpcy5hcHBlbmRIZWFkZXJzKGhlYWRlcnMpO1xuICAgICAgICBjb25zdCBvYnMgPSB0aGlzLmh0dHAucHV0KHVybCwgc2VyaWFsaXplKGJvZHkpLCB7XG4gICAgICAgICAgICBoZWFkZXJzOiBodHRwSGVhZGVyc1xuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIG9icy5waXBlKFxuICAgICAgICAgICAgbWFwKHJlcyA9PiByZXMgJiYgcmVzWydqc29uJ10gJiYgdHlwZW9mIHJlc1snanNvbiddID09PSAnZnVuY3Rpb24nID8gcmVzWydqc29uJ10oKSA6IHJlcyksXG4gICAgICAgICAgICBjYXRjaEVycm9yKGVyciA9PiB0aGlzLm9uRXJyb3IoZXJyKSksXG4gICAgICAgICAgICBmaW5hbGl6ZSgoKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5vbkNvbXBsZXRlKCdQVVQnLCB1cmwpO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBUaGlzIG1ldGhvZCB3aWxsIGJlIHVzZWQgdG8gZm9ybWF0IFVSTHMgZm9yIGFsbCBjcm9zcy1vcmlnaW4gcmVxdWVzdHMuXG4gICAgICovXG4gICAgZm9ybWF0VXJsKHBhdGg6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiBgJHt0aGlzLmJhc2VVcmx9LyR7cGF0aH1gO1xuICAgIH1cblxuICAgIC8qKiBcbiAgICAgKiBVc2UgdGhpcyBtZXRob2Qgd2hlbiBhIHByb21pc2UgaXMgcHJlZmVycmVkIG92ZXIgYW4gb2JzZXJ2YWJsZS5cbiAgICAgKi9cbiAgICBnZXRQcm9taXNlKHVybDogc3RyaW5nKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmdldCh1cmwpXG4gICAgICAgICAgICAudG9Qcm9taXNlKClcbiAgICAgICAgICAgIC50aGVuKHJlcyA9PiByZXMuanNvbigpKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIG9uRXJyb3IoZXJyb3I6IGFueSkge1xuICAgICAgICBsZXQgZXJyb3JCb2R5OiBhbnk7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBlcnJvckJvZHkgPSAoZXJyb3IuX2JvZHkpID8gSlNPTi5wYXJzZShlcnJvci5fYm9keSkgOiB7IG1lc3NhZ2U6ICdJbnRlcm5hbCBzZXJ2ZXIgZXJyb3InLCBzdGF0dXNDb2RlOiBlcnJvci5zdGF0dXMgfTtcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgaWYgKGVycm9yLnN0YXR1cyA8PSAwKSB7XG4gICAgICAgICAgICAgICAgZXJyb3JCb2R5ID0geyBtZXNzYWdlOiAnSW50ZXJuYWwgc2VydmVyIGVycm9yLicsIHN0YXR1c0NvZGU6IDUwMCB9O1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmIChlcnJvckJvZHkubWVzc2FnZSkge1xuICAgICAgICAgICAgZXJyb3JCb2R5Lm1lc3NhZ2UgPSBlcnJvckJvZHkubWVzc2FnZS5yZXBsYWNlKCdBbiBlcnJvciBoYXMgb2NjdXJlZCBpbiB0aGUgYXBpLlN5c3RlbS5FeGNlcHRpb246ICcsICcnKTtcbiAgICAgICAgICAgIGVycm9yQm9keS5tZXNzYWdlID0gZXJyb3JCb2R5Lm1lc3NhZ2Uuc3Vic3RyaW5nKDAsIGVycm9yQm9keS5tZXNzYWdlLmluZGV4T2YoJyBhdCcpKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhyb3dFcnJvcihlcnJvckJvZHkpO1xuICAgIH1cblxuICAgIHByaXZhdGUgb25Db21wbGV0ZShtZXRob2Q6IHN0cmluZywgdXJsOiBzdHJpbmcpOiB2b2lkIHtcbiAgICAgICAgaWYgKHRoaXMubG9nRXZlbnRzKSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhgQ29tcGxldGVkICR7bWV0aG9kfSByZXF1ZXN0IHRvICR7dXJsfWApO1xuICAgICAgICB9XG4gICAgfVxuXG59XG4iXX0=